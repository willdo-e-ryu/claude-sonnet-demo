name: CD with GitHub Copilot Analysis

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]

env:
  REGISTRY: ghcr.io
  REGISTRY_NAMESPACE: ${{ github.repository_owner }}
  IMAGE_NAME: flappy-nginx

jobs:
  build-deploy-copilot:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      pull-requests: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install GitHub CLI with Copilot
      run: |
        # GitHub CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y
        
        # Copilot æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        gh extension install github/gh-copilot
        echo "âœ… GitHub CLI with Copilot ready for CD pipeline"
    
    - name: Authenticate GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "$GH_TOKEN" | gh auth login --with-token
    
    - name: Pre-deployment Copilot Analysis
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "## ðŸš€ CD - GitHub Copilot ãƒ‡ãƒ—ãƒ­ã‚¤åˆ†æž" > cd_copilot_report.md
        echo "" >> cd_copilot_report.md
        echo "### ðŸ“… ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹æ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')" >> cd_copilot_report.md
        echo "### ðŸ·ï¸ ãƒªãƒªãƒ¼ã‚¹: ${{ github.ref_name }}" >> cd_copilot_report.md
        echo "" >> cd_copilot_report.md
        
        # Copilot ã§ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥åˆ†æž
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "### ðŸ¤– Copilot ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆåˆ†æž" >> cd_copilot_report.md
          echo "" >> cd_copilot_report.md
          
          # ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹å–å¾—
          {
            echo "nginx Alpine Docker ã‚³ãƒ³ãƒ†ãƒŠã®æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã«ã¤ã„ã¦ææ¡ˆã—ã¦ãã ã•ã„" | \
            gh copilot suggest 2>/dev/null | head -20
          } >> cd_copilot_report.md 2>/dev/null || {
            echo "**ðŸ’« æ¨™æº–ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæŽ¨å¥¨äº‹é …:**" >> cd_copilot_report.md
            echo "- ðŸ”’ HTTPS/TLSè¨¼æ˜Žæ›¸ã®è¨­å®š" >> cd_copilot_report.md
            echo "- ðŸš€ ãƒ–ãƒ«ãƒ¼ãƒ»ã‚°ãƒªãƒ¼ãƒ³ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ" >> cd_copilot_report.md
            echo "- ðŸ“Š ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°" >> cd_copilot_report.md
            echo "- ðŸ”„ è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½" >> cd_copilot_report.md
          }
        fi
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=tag
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}
    
    - name: Build Docker Image with Copilot Analysis
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "" >> cd_copilot_report.md
        echo "### ðŸ³ Docker ãƒ“ãƒ«ãƒ‰ & Copilot æœ€é©åŒ–åˆ†æž" >> cd_copilot_report.md
        echo "" >> cd_copilot_report.md
        
        # Docker ãƒ“ãƒ«ãƒ‰é–‹å§‹æ™‚åˆ»è¨˜éŒ²
        BUILD_START=$(date +%s)
        echo "**ðŸ”¨ ãƒ“ãƒ«ãƒ‰é–‹å§‹:** $(date '+%H:%M:%S')" >> cd_copilot_report.md
        
        # Copilot ã§Dockerfileæœ€é©åŒ–ææ¡ˆ
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "" >> cd_copilot_report.md
          echo "**ðŸ¤– Copilot Dockerfile æœ€é©åŒ–ææ¡ˆ:**" >> cd_copilot_report.md
          
          # Dockerfileã®å†…å®¹ã‚’åŸºã«æœ€é©åŒ–ææ¡ˆ
          if [ -f "Dockerfile" ]; then
            DOCKERFILE_PREVIEW=$(head -10 Dockerfile | grep -v '^#' | head -5)
            {
              echo "ä»¥ä¸‹ã®Dockerfileæ§‹æˆã®æœ¬ç•ªç’°å¢ƒå‘ã‘æœ€é©åŒ–ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–ã«ã¤ã„ã¦ææ¡ˆã—ã¦ãã ã•ã„: $DOCKERFILE_PREVIEW" | \
              gh copilot suggest 2>/dev/null | head -15
            } >> cd_copilot_report.md 2>/dev/null || {
              echo "- ðŸš€ ãƒžãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®æ´»ç”¨" >> cd_copilot_report.md
              echo "- ðŸ”’ éžrootãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ã®å®Ÿè¡Œ" >> cd_copilot_report.md
              echo "- ðŸ“¦ ä¸è¦ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®é™¤åŽ»" >> cd_copilot_report.md
            }
          fi
        fi
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        platforms: linux/amd64,linux/arm64
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: Record Build Metrics
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        echo "" >> cd_copilot_report.md
        echo "**ðŸ“Š ãƒ“ãƒ«ãƒ‰ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**" >> cd_copilot_report.md
        echo "- â±ï¸ ãƒ“ãƒ«ãƒ‰æ™‚é–“: ${BUILD_TIME} ç§’" >> cd_copilot_report.md
        echo "- ðŸ—ï¸ ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : linux/amd64, linux/arm64" >> cd_copilot_report.md
        echo "- ðŸ“¦ ãƒ¬ã‚¸ã‚¹ãƒˆãƒª: ${{ env.REGISTRY }}" >> cd_copilot_report.md
        echo "" >> cd_copilot_report.md

    - name: Pre-deployment Copilot Security Check
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SSH_HOST: ${{ secrets.SSH_HOST }}
      run: |
        echo "### ï¿½ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ & ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæº–å‚™" >> cd_copilot_report.md
        echo "" >> cd_copilot_report.md
        
        # ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šã®ç¢ºèª
        echo "**âš™ï¸ ãƒ‡ãƒ—ãƒ­ã‚¤è¨­å®šç¢ºèª:**" >> cd_copilot_report.md
        
        if [ -n "$SSH_HOST" ]; then
          echo "- âœ… SSH_HOST: è¨­å®šæ¸ˆã¿" >> cd_copilot_report.md
          echo "- âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å…ˆ: æœ¬ç•ªã‚µãƒ¼ãƒãƒ¼" >> cd_copilot_report.md
        else
          echo "- â­ï¸ SSH_HOST: æœªè¨­å®šï¼ˆã‚³ãƒ³ãƒ†ãƒŠãƒ¬ã‚¸ã‚¹ãƒˆãƒªã®ã¿ï¼‰" >> cd_copilot_report.md
        fi
        
        echo "- âœ… SSH_USER: ${{ secrets.SSH_USER != '' && 'è¨­å®šæ¸ˆã¿' || 'æœªè¨­å®š' }}" >> cd_copilot_report.md
        echo "- âœ… SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY != '' && 'è¨­å®šæ¸ˆã¿' || 'æœªè¨­å®š' }}" >> cd_copilot_report.md
        echo "- âœ… DEPLOY_DIR: ${{ secrets.DEPLOY_DIR != '' && 'è¨­å®šæ¸ˆã¿' || 'æœªè¨­å®š' }}" >> cd_copilot_report.md
        
        echo "" >> cd_copilot_report.md
        
        # Copilot ã§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æž
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "**ðŸ¤– Copilot ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†æž:**" >> cd_copilot_report.md
          echo "" >> cd_copilot_report.md
          
          {
            echo "nginx Docker ã‚³ãƒ³ãƒ†ãƒŠã®æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã«ãŠã‘ã‚‹ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’æ•™ãˆã¦ãã ã•ã„" | \
            gh copilot suggest 2>/dev/null | head -15
          } >> cd_copilot_report.md 2>/dev/null || {
            echo "- ðŸ›¡ï¸ nginx ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š" >> cd_copilot_report.md
            echo "- ðŸ”¥ ãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šã®ç¢ºèª" >> cd_copilot_report.md
            echo "- ðŸ“Š ãƒ­ã‚°ç›£è¦–ã¨ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š" >> cd_copilot_report.md
            echo "- ðŸ”„ å®šæœŸçš„ãªã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆ" >> cd_copilot_report.md
          }
        fi
    
    - name: Deploy to Production Server (with Copilot)
      if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v'))
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      uses: appleboy/ssh-action@v1.1.0
      with:
        host: ${{ secrets.SSH_HOST }}
        port: ${{ secrets.SSH_PORT || '22' }}
        username: ${{ secrets.SSH_USER || 'ubuntu' }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          # SSH_HOSTãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if [ -z "${{ secrets.SSH_HOST }}" ]; then
            echo "SSH_HOST not configured - skipping deployment"
            exit 0
          fi
          
          # GitHub Container Registry ã¸ã®ãƒ­ã‚°ã‚¤ãƒ³
          echo "${{ secrets.GITHUB_TOKEN }}" | docker login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin
          
          # æ–°ã—ã„ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ãƒ—ãƒ«
          docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          
          # æ—¢å­˜ã‚³ãƒ³ãƒ†ãƒŠåœæ­¢ãƒ»å‰Šé™¤ï¼ˆã‚¨ãƒ©ãƒ¼ã‚’ç„¡è¦–ï¼‰
          docker stop flappy-nginx-prod || true
          docker rm flappy-nginx-prod || true
          
          # æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
          docker run -d -p 8080:80 --name flappy-nginx-prod \
            --restart unless-stopped \
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
          
          # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
          sleep 5
          curl -f http://localhost:8080/health || echo "Health check warning"
          
          echo "âœ… Production deployment completed!"
    
    - name: Finalize Copilot CD Report
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "" >> cd_copilot_report.md
        echo "---" >> cd_copilot_report.md
        echo "" >> cd_copilot_report.md
        echo "ðŸ¤– **GitHub Copilot CD åˆ†æžå®Œäº†** - $(date '+%Y-%m-%d %H:%M:%S')" >> cd_copilot_report.md
        echo "" >> cd_copilot_report.md
        echo "**ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†:** ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}" >> cd_copilot_report.md
    
    - name: Create Enhanced Deployment Summary
      if: always()
      env:
        SSH_HOST: ${{ secrets.SSH_HOST }}
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHub Issues ã«ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãƒ¬ãƒãƒ¼ãƒˆä½œæˆï¼ˆæˆåŠŸæ™‚ã®ã¿ï¼‰
        if [ "${{ job.status }}" = "success" ]; then
          echo "## ðŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Œäº†ãƒ¬ãƒãƒ¼ãƒˆ" > deploy_summary.md
          echo "" >> deploy_summary.md
          echo "### ðŸ“‹ ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±" >> deploy_summary.md
          echo "- **ãƒªãƒªãƒ¼ã‚¹**: ${{ github.ref_name }}" >> deploy_summary.md
          echo "- **ã‚³ãƒŸãƒƒãƒˆ**: ${{ github.sha }}" >> deploy_summary.md
          echo "- **ã‚¤ãƒ¡ãƒ¼ã‚¸**: \`${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}\`" >> deploy_summary.md
          echo "- **ãƒ‡ãƒ—ãƒ­ã‚¤æ—¥æ™‚**: $(date '+%Y-%m-%d %H:%M:%S')" >> deploy_summary.md
          echo "" >> deploy_summary.md
          
          if [ -n "$SSH_HOST" ]; then
            echo "- **URL**: http://$SSH_HOST:8080" >> deploy_summary.md
            echo "- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†" >> deploy_summary.md
          else
            echo "- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: â­ï¸ ãƒ¬ã‚¸ã‚¹ãƒˆãƒªãƒ—ãƒƒã‚·ãƒ¥å®Œäº†" >> deploy_summary.md
          fi
          
          # Copilot åˆ†æžçµæžœã‚‚è¿½åŠ 
          echo "" >> deploy_summary.md
          cat cd_copilot_report.md >> deploy_summary.md
        fi
        
        # GitHub Step Summary ä½œæˆ
        echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é …ç›® | å€¤ |" >> $GITHUB_STEP_SUMMARY
        echo "|---|---|" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚¤ãƒ¡ãƒ¼ã‚¸ | \`${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ã‚³ãƒŸãƒƒãƒˆ | ${{ github.sha }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ãƒ–ãƒ©ãƒ³ãƒ/ã‚¿ã‚° | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ] && [ -n "$SSH_HOST" ]; then
          echo "| ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ | âœ… æˆåŠŸ |" >> $GITHUB_STEP_SUMMARY
          echo "| URL | http://$SSH_HOST:8080 |" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" = "success" ] && [ -z "$SSH_HOST" ]; then
          echo "| ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ | â­ï¸ ã‚¹ã‚­ãƒƒãƒ— |" >> $GITHUB_STEP_SUMMARY
          echo "| ãƒ¬ã‚¸ã‚¹ãƒˆãƒª | âœ… ãƒ—ãƒƒã‚·ãƒ¥å®Œäº† |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ | âŒ å¤±æ•— |" >> $GITHUB_STEP_SUMMARY
        fi
