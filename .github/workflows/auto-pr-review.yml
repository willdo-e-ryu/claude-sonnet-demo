name: Auto PR with Copilot Review

on:
  push:
    branches-ignore:
      - main
      - master
      - develop
  # feature/fix/ãªã©ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ

permissions:
  contents: write
  pull-requests: write
  issues: write
  repository-projects: read
  actions: read
  checks: read
  statuses: read

jobs:
  auto-pr-and-review:
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master' && github.ref != 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get branch info
      id: branch_info
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        BASE_BRANCH="master"
        
        # developãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆ
        if git show-ref --verify --quiet refs/remotes/origin/develop; then
          BASE_BRANCH="develop"
        # mainãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        elif git show-ref --verify --quiet refs/remotes/origin/main; then
          BASE_BRANCH="main"
        fi
        
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
        echo "pr_title=ðŸ”„ Auto PR: $BRANCH_NAME" >> $GITHUB_OUTPUT
    
    - name: Check if PR already exists
      id: check_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
        BASE_BRANCH="${{ steps.branch_info.outputs.base_branch }}"
        
        # æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
        PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --base "$BASE_BRANCH" --json number --jq '.[0].number // empty' || echo "")
        
        if [ -n "$PR_NUMBER" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "æ—¢å­˜ã®PR #$PR_NUMBER ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "æ–°ã—ã„PRã‚’ä½œæˆã—ã¾ã™"
        fi
    
    - name: Generate commit summary
      id: commit_summary
      run: |
        BASE_BRANCH="${{ steps.branch_info.outputs.base_branch }}"
        
        # ã‚³ãƒŸãƒƒãƒˆã®å·®åˆ†ã‚’å–å¾—
        COMMITS=$(git log --oneline origin/$BASE_BRANCH..HEAD | head -10)
        FILES_CHANGED=$(git diff --name-only origin/$BASE_BRANCH..HEAD | head -20)
        
        # PRæœ¬æ–‡ã‚’ç”Ÿæˆï¼ˆsedã®ä»£ã‚ã‚Šã«echoã¨catã‚’ä½¿ç”¨ï¼‰
        {
          echo "## ðŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸPull Request"
          echo ""
          echo "### ðŸ“ å¤‰æ›´å†…å®¹"
          echo "**å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:**"
          echo '```'
          echo "$FILES_CHANGED"
          echo '```'
          echo ""
          echo "**ã‚³ãƒŸãƒƒãƒˆå±¥æ­´:**"
          echo '```'
          echo "$COMMITS"
          echo '```'
          echo ""
          echo "### ðŸ” ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒã‚¤ãƒ³ãƒˆ"
          echo "- [ ] ã‚³ãƒ¼ãƒ‰å“è³ª"
          echo "- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£"
          echo "- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹"
          echo "- [ ] ãƒ†ã‚¹ãƒˆã‚«ãƒãƒ¬ãƒƒã‚¸"
          echo "- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ"
          echo ""
          echo "### ðŸš€ ãƒ†ã‚¹ãƒˆçŠ¶æ³"
          echo "ã“ã®PRã¯è‡ªå‹•çš„ã«ä»¥ä¸‹ã®ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ã¾ã™ï¼š"
          echo "- âœ… æ§‹æ–‡ãƒã‚§ãƒƒã‚¯"
          echo "- âœ… Docker ãƒ“ãƒ«ãƒ‰ãƒ†ã‚¹ãƒˆ"
          echo "- âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³"
          echo "- âœ… GitHub Copilot AI ãƒ¬ãƒ“ãƒ¥ãƒ¼"
          echo ""
          echo "### ðŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ"
          echo "- [ ] å¤‰æ›´å†…å®¹ã‚’ç¢ºèªæ¸ˆã¿"
          echo "- [ ] ãƒ†ã‚¹ãƒˆãŒé€šéŽã™ã‚‹ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿"
          echo "- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°æ¸ˆã¿ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰"
          echo "- [ ] ç ´å£Šçš„å¤‰æ›´ãŒãªã„ã“ã¨ã‚’ç¢ºèªæ¸ˆã¿"
          echo ""
          echo "---"
          echo "ðŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼"
        } > pr_body.md
        
        echo "body_file=pr_body.md" >> $GITHUB_OUTPUT
    
    - name: Create Pull Request
      if: steps.check_pr.outputs.exists == 'false'
      id: create_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
        BASE_BRANCH="${{ steps.branch_info.outputs.base_branch }}"
        PR_TITLE="${{ steps.branch_info.outputs.pr_title }}"
        
        # PRæœ¬æ–‡ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
        if [ ! -f pr_body.md ]; then
          echo "âš ï¸ pr_body.md ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœ¬æ–‡ã‚’ä½œæˆã—ã¾ã™ã€‚"
          echo "## ðŸ¤– è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸPull Request" > pr_body.md
          echo "" >> pr_body.md
          echo "ãƒ–ãƒ©ãƒ³ãƒ \`$BRANCH_NAME\` ã‹ã‚‰ \`$BASE_BRANCH\` ã¸ã®å¤‰æ›´ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚" >> pr_body.md
        fi
        
        # GitHub CLI ã§PRã‚’ä½œæˆ
        PR_URL=$(gh pr create \
          --title "$PR_TITLE" \
          --body-file pr_body.md \
          --base "$BASE_BRANCH" \
          --head "$BRANCH_NAME" \
          --label "auto-generated,needs-review" \
          --repo ${{ github.repository }})
        
        # PRç•ªå·ã‚’æŠ½å‡º
        PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]\+$')
        
        echo "âœ… PR #$PR_NUMBER ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: $PR_URL"
        echo "pull-request-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "pull-request-url=$PR_URL" >> $GITHUB_OUTPUT
    
    - name: Add labels to PR
      if: steps.create_pr.outputs.pull-request-number != '' || steps.check_pr.outputs.exists == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # æ–°è¦ä½œæˆã•ã‚ŒãŸPRã¾ãŸã¯æ—¢å­˜ã®PRã®ç•ªå·ã‚’å–å¾—
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
          echo "æ—¢å­˜ã®PR #$PR_NUMBER ã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã™"
        else
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
          echo "æ–°è¦PR #$PR_NUMBER ã«ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã™"
        fi
        
        BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
        
        # è¿½åŠ ã®ãƒ–ãƒ©ãƒ³ãƒå›ºæœ‰ãƒ©ãƒ™ãƒ«
        ADDITIONAL_LABELS=""
        
        if [[ "$BRANCH_NAME" == feature/* ]]; then
          ADDITIONAL_LABELS="enhancement"
        elif [[ "$BRANCH_NAME" == fix/* ]] || [[ "$BRANCH_NAME" == bugfix/* ]]; then
          ADDITIONAL_LABELS="bug"
        elif [[ "$BRANCH_NAME" == hotfix/* ]]; then
          ADDITIONAL_LABELS="hotfix,priority-high"
        elif [[ "$BRANCH_NAME" == docs/* ]]; then
          ADDITIONAL_LABELS="documentation"
        fi
        
        if [ -n "$ADDITIONAL_LABELS" ]; then
          gh pr edit "$PR_NUMBER" --add-label "$ADDITIONAL_LABELS" || echo "è¿½åŠ ãƒ©ãƒ™ãƒ«è¨­å®šã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ"
        fi
    

    
    - name: Basic code analysis
      id: code_analysis
      if: steps.create_pr.outputs.pull-request-number != '' || steps.check_pr.outputs.exists == 'true'
      continue-on-error: true
      run: |
        # åŸºæœ¬çš„ãªã‚³ãƒ¼ãƒ‰åˆ†æžï¼ˆPRç•ªå·ã‚’å–å¾—ï¼‰
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
        else
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
        fi
        
        if [ -z "$PR_NUMBER" ]; then
          echo "PRç•ªå·ãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
          exit 0
        fi
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æƒ…å ±
        CHANGED_FILES=$(git diff --name-only origin/${{ steps.branch_info.outputs.base_branch }}..HEAD || true)
        
        if [ -n "$CHANGED_FILES" ]; then
          echo "## ï¿½ å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æž" > basic_analysis.md
          echo "" >> basic_analysis.md
          echo "### å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«" >> basic_analysis.md
          echo '```' >> basic_analysis.md
          echo "$CHANGED_FILES" >> basic_analysis.md
          echo '```' >> basic_analysis.md
          echo "" >> basic_analysis.md
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¨å¤‰æ›´è¡Œæ•°ã®çµ±è¨ˆ
          FILE_COUNT=$(echo "$CHANGED_FILES" | wc -l)
          TOTAL_ADDITIONS=$(git diff --numstat origin/${{ steps.branch_info.outputs.base_branch }}..HEAD | awk '{sum+=$1} END {print sum+0}')
          TOTAL_DELETIONS=$(git diff --numstat origin/${{ steps.branch_info.outputs.base_branch }}..HEAD | awk '{sum+=$2} END {print sum+0}')
          
          echo "### ðŸ“ˆ å¤‰æ›´çµ±è¨ˆ" >> basic_analysis.md
          echo "- **å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°**: $FILE_COUNT" >> basic_analysis.md
          echo "- **è¿½åŠ è¡Œæ•°**: +$TOTAL_ADDITIONS" >> basic_analysis.md
          echo "- **å‰Šé™¤è¡Œæ•°**: -$TOTAL_DELETIONS" >> basic_analysis.md
          echo "" >> basic_analysis.md
          echo "---" >> basic_analysis.md
          echo "è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ @Copilot ãŒå®Ÿè¡Œã—ã¾ã™ã€‚" >> basic_analysis.md
          
          # åˆ†æžçµæžœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
          gh pr comment "$PR_NUMBER" --body-file basic_analysis.md
        fi
    
    - name: Update PR status
      if: steps.create_pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
        
        echo "âœ… PR #$PR_NUMBER ã®è‡ªå‹•ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãŒå®Œäº†ã—ã¾ã—ãŸ"
    
    - name: Notify in PR
      if: steps.create_pr.outputs.pull-request-number != ''
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
        
        cat > final_notification.md << 'EOF'
        ## ðŸŽ‰ è‡ªå‹•PRä½œæˆå®Œäº†ï¼
        
        ã“ã®PRã¯è‡ªå‹•çš„ã«ä½œæˆãƒ»è¨­å®šã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®ä½œæ¥­ãŒå®Œäº†ã—ã¦ã„ã¾ã™ï¼š
        
        âœ… **åŸºæœ¬è¨­å®š**
        - Pull Requestä½œæˆ
        - é©åˆ‡ãªãƒ©ãƒ™ãƒ«ä»˜ä¸Ž
        - ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒè¨­å®š
        
        âœ… **ã‚³ãƒ¼ãƒ‰åˆ†æž**
        - åŸºæœ¬çš„ãªãƒ•ã‚¡ã‚¤ãƒ«åˆ†æž
        - å¤‰æ›´çµ±è¨ˆæƒ…å ±
        - GitHub Copilot AI ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚
        
        âœ… **CI/CDçµ±åˆ**
        - è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œäºˆç´„
        - ãƒ“ãƒ«ãƒ‰æ¤œè¨¼è¨­å®š
        
        ### ðŸ”„ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
        1. ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®ç¢ºèª
        2. ãƒ†ã‚¹ãƒˆçµæžœã®ç¢ºèª
        3. å¿…è¦ã«å¿œã˜ã¦ä¿®æ­£
        4. ãƒžãƒ¼ã‚¸æº–å‚™
        
        ---
        ðŸ“ **ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã®æ–¹ã¸**: ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã™ãŒã€äººã®ç›®ã«ã‚ˆã‚‹ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚‚é‡è¦ã§ã™ã€‚ç‰¹ã«ä»¥ä¸‹ã®ç‚¹ã‚’ã”ç¢ºèªãã ã•ã„ï¼š
        - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å¦¥å½“æ€§
        - ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£
        - æ„å›³ã—ãŸå‹•ä½œã¨ã®æ•´åˆæ€§
        EOF
        
        gh pr comment "$PR_NUMBER" --body-file final_notification.md
    
    - name: Check for existing Copilot reviews
      if: steps.create_pr.outputs.pull-request-number != '' || steps.check_pr.outputs.exists == 'true'
      id: check_copilot_review
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # PRç•ªå·ã‚’å–å¾—
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
        else
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
        fi
        
        echo "ðŸ” PR #$PR_NUMBER ã§Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã¾ã™..."
        
        # PRã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ³ã‚’è©³ç´°ã«ãƒã‚§ãƒƒã‚¯
        COPILOT_REVIEWS=$(gh pr view "$PR_NUMBER" --json reviews --jq '.reviews[] | select(.author.login | contains("copilot") or contains("github-copilot")) | {state: .state, submittedAt: .submittedAt}' || echo "")
        COPILOT_COMMENTS=$(gh pr view "$PR_NUMBER" --json comments --jq '.comments[] | select(.author.login == "copilot" or .body | contains("@copilot") or .body | contains("Copilot") or .body | contains("copilot")) | .body' || echo "")
        
        # ãƒ¬ãƒ“ãƒ¥ãƒ¼å­˜åœ¨ãƒã‚§ãƒƒã‚¯
        if [ -n "$COPILOT_REVIEWS" ]; then
          echo "âœ… Copilotã®æ­£å¼ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ"
          echo "copilot_review_exists=true" >> $GITHUB_OUTPUT
          
          # ãƒ¬ãƒ“ãƒ¥ãƒ¼ã®è©³ç´°ã‚’è¡¨ç¤º
          echo "ðŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼è©³ç´°:"
          echo "$COPILOT_REVIEWS"
          
          # æœ€æ–°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          LATEST_REVIEW_STATE=$(echo "$COPILOT_REVIEWS" | jq -r '.state' | tail -1)
          echo "ðŸŽ¯ æœ€æ–°ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹: $LATEST_REVIEW_STATE"
          echo "copilot_latest_review_state=$LATEST_REVIEW_STATE" >> $GITHUB_OUTPUT
          
        elif [ -n "$COPILOT_COMMENTS" ]; then
          echo "ðŸ“ Copilotã®ã‚³ãƒ¡ãƒ³ãƒˆ/ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼ˆæ­£å¼ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ã¾ã ï¼‰"
          echo "copilot_review_exists=false" >> $GITHUB_OUTPUT
          echo "copilot_latest_review_state=none" >> $GITHUB_OUTPUT
        else
          echo "âŒ Copilotã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¾ãŸã¯ã‚³ãƒ¡ãƒ³ãƒˆã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo "copilot_review_exists=false" >> $GITHUB_OUTPUT
          echo "copilot_latest_review_state=none" >> $GITHUB_OUTPUT
        fi
        
        # ã‚³ãƒ¡ãƒ³ãƒˆå¿œç­”ãƒã‚§ãƒƒã‚¯
        if [ -n "$COPILOT_COMMENTS" ]; then
          COPILOT_RESPONSE=$(echo "$COPILOT_COMMENTS" | grep -i "copilot" | head -5)
          if [ -n "$COPILOT_RESPONSE" ]; then
            echo "ðŸ¤– Copilotã‹ã‚‰ã®å¿œç­”ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ"
            echo "copilot_responded=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ Copilotãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã¯ã‚ã‚Šã¾ã™ãŒã€å¿œç­”ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“"
            echo "copilot_responded=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "copilot_responded=false" >> $GITHUB_OUTPUT
        fi

    - name: Request GitHub Copilot Review
      if: steps.create_pr.outputs.pull-request-number != '' || steps.check_pr.outputs.exists == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # PRç•ªå·ã‚’å–å¾—ï¼ˆæ–°è¦ä½œæˆã¾ãŸã¯æ—¢å­˜PRï¼‰
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
          echo "æ—¢å­˜ã®PR #$PR_NUMBER ã«æ–°ã—ã„Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚ã—ã¾ã™"
          PR_STATUS="æ—¢å­˜PRã®æ›´æ–°"
        else
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
          echo "æ–°è¦PR #$PR_NUMBER ã«Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚ã—ã¾ã™"
          PR_STATUS="æ–°è¦PRä½œæˆ"
        fi
        
        # ç¾åœ¨ã®æ—¥æ™‚ã‚’å–å¾—
        CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
        
        # Copilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã®å­˜åœ¨çŠ¶æ³ã«å¿œã˜ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’èª¿æ•´
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          if [ "${{ steps.check_copilot_review.outputs.copilot_responded }}" == "true" ]; then
            echo "ðŸ”„ Copilotã‹ã‚‰ã®æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¯¾ã™ã‚‹è¿½åŠ è³ªå•ã‚’é€ä¿¡ã—ã¾ã™"
            REVIEW_TYPE="è¿½åŠ ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚"
          else
            echo "ðŸ”„ æ—¢å­˜PRã«å¯¾ã™ã‚‹å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚ã—ã¾ã™"
            REVIEW_TYPE="å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚"
          fi
        else
          echo "ðŸ†• åˆå›žCopilotãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚ã—ã¾ã™"
          REVIEW_TYPE="åˆå›žãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚"
        fi
        
        cat > copilot_request.md << EOF
        ## ðŸ¤– GitHub Copilot AI ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ ($PR_STATUS - $REVIEW_TYPE)
        
        **ðŸ“… è¦æ±‚æ—¥æ™‚**: $CURRENT_TIME
        
        @copilot ã“ã®PRã®åŒ…æ‹¬çš„ãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’**å¿…ãšæ—¥æœ¬èªžã§**ãŠé¡˜ã„ã—ã¾ã™ã€‚
        
        **ðŸŒ é‡è¦ãªæ³¨æ„**: ã™ã¹ã¦ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã€åˆ†æžã€ææ¡ˆã¯**æ—¥æœ¬èªž**ã§è¨˜è¿°ã—ã¦ãã ã•ã„ã€‚è‹±èªžã¯ä½¿ç”¨ã—ãªã„ã§ãã ã•ã„ã€‚
        
        ### ðŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼é …ç›®ï¼ˆæ—¥æœ¬èªžã§å›žç­”ï¼‰
        
        **ðŸ” ã‚³ãƒ¼ãƒ‰å“è³ªåˆ†æž:**
        - å‘½åè¦å‰‡ã¨ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ã‚¤ãƒ«ã®è©•ä¾¡
        - é–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹ã®è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã®é©åˆ‡æ€§
        - ã‚³ãƒ¡ãƒ³ãƒˆã¨å¯èª­æ€§ã®æ”¹å–„ææ¡ˆ
        
        **ðŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹è©•ä¾¡:**
        - ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®åŠ¹çŽ‡æ€§åˆ†æž
        - ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã®æœ€é©åŒ–ææ¡ˆ
        - Canvas API ã®æç”»å‡¦ç†æœ€é©åŒ–
        
        **ðŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯:**
        - å…¥åŠ›å€¤æ¤œè¨¼ã®å®Ÿè£…çŠ¶æ³
        - XSS/CSRFå¯¾ç­–ã®ç¢ºèª
        - ãƒ‡ãƒ¼ã‚¿éœ²å‡ºãƒªã‚¹ã‚¯ã®è©•ä¾¡
        
        **ðŸ§ª ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£:**
        - ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå¯èƒ½æ€§ã®è©•ä¾¡
        - ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ€§ã¨ä¾å­˜é–¢ä¿‚ã®åˆ†æž
        - ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®æ”¹å–„ææ¡ˆ
        
        **ðŸ“± ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£:**
        - ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œã®ç¢ºèª
        - ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®è©•ä¾¡
        - ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ã®æ”¹å–„ææ¡ˆ
        
        ### ðŸŽ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã®è©•ä¾¡ç‚¹ï¼ˆæ—¥æœ¬èªžã§åˆ†æžï¼‰
        
        1. **Flappy Bird ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯** - ã‚²ãƒ¼ãƒ çŠ¶æ…‹ç®¡ç†ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒ«ãƒ¼ãƒ—ã®åŠ¹çŽ‡æ€§
        2. **Canvas æç”»å‡¦ç†** - 400x600ã‚µã‚¤ã‚ºã§ã®æç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–
        3. **UI/UX ãƒ‡ã‚¶ã‚¤ãƒ³** - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã®å‘ä¸Šææ¡ˆ
        4. **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ** - ã‚³ãƒ¼ãƒ‰ã®ä¿å®ˆæ€§ã¨æ‹¡å¼µæ€§ã®è©•ä¾¡
        
        ### ðŸŽ® ã‚²ãƒ¼ãƒ ç‰¹åŒ–ã®è³ªå•ï¼ˆæ—¥æœ¬èªžã§å›žç­”ï¼‰
        
        @copilot ä»¥ä¸‹ã«ã¤ã„ã¦ã‚‚**å¿…ãšæ—¥æœ¬èªžã§**å…·ä½“çš„ãªåˆ†æžã¨ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š
        
        - ç¾åœ¨ã®ã‚²ãƒ¼ãƒ ãƒãƒ©ãƒ³ã‚¹ï¼ˆãƒ‘ã‚¤ãƒ—é–“éš”200pxã€é‡åŠ›0.5ã€ã‚¸ãƒ£ãƒ³ãƒ—åŠ›-8ï¼‰ã¯é©åˆ‡ã‹ï¼Ÿ
        - Canvas ã‚µã‚¤ã‚º400x600ã§ã®æç”»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã‚’å‘ä¸Šã•ã›ã‚‹å…·ä½“çš„ãªæ–¹æ³•ã¯ï¼Ÿ
        - ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼ç”»é¢ã®UXã‚’æ”¹å–„ã™ã‚‹å…·ä½“çš„ãªã‚¢ã‚¤ãƒ‡ã‚¢ã¯ï¼Ÿ
        - ãƒ¢ãƒã‚¤ãƒ«ãƒ‡ãƒã‚¤ã‚¹ï¼ˆã‚¿ãƒƒãƒæ“ä½œï¼‰ã§ã®æ“ä½œæ€§ã‚’å‘ä¸Šã•ã›ã‚‹æ–¹æ³•ã¯ï¼Ÿ
        - ES6+ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ§‹é€ ã®æ”¹å–„æ¡ˆã¯ï¼Ÿ
        
        ### ðŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ”¹å–„ææ¡ˆï¼ˆæ—¥æœ¬èªžã§ææ¡ˆï¼‰
        
        @copilot ä»¥ä¸‹ã®è¦³ç‚¹ã‹ã‚‰**æ—¥æœ¬èªžã§**æ”¹å–„ææ¡ˆã‚’ãŠé¡˜ã„ã—ã¾ã™ï¼š
        
        - ã‚¯ãƒ©ã‚¹è¨­è¨ˆã¨ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæŒ‡å‘çš„ãªæ”¹å–„
        - çŠ¶æ…‹ç®¡ç†ã®æœ€é©åŒ–ï¼ˆREADY/PLAYING/GAME_OVERï¼‰
        - è¡çªåˆ¤å®šã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®åŠ¹çŽ‡åŒ–
        - ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ãƒ«ãƒ¼ãƒ—ã®æœ€é©åŒ–
        - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å¼·åŒ–
        
        **ðŸ“ æ³¨æ„**: GitHub Copilot Pull Request Reviewerã®è¨­å®šã«ã‚ˆã‚Šã€ã™ã¹ã¦ã®åˆ†æžã¨ã‚³ãƒ¡ãƒ³ãƒˆã¯**æ—¥æœ¬èªž**ã§æä¾›ã•ã‚Œã¾ã™ã€‚
        
        @copilot **æ—¥æœ¬èªžã§ã®**è©³ç´°ãªåˆ†æžã¨æ”¹å–„ææ¡ˆã‚’ã‚ˆã‚ã—ããŠé¡˜ã„ã—ã¾ã™ï¼
        
        ---
        *ðŸ”„ ã“ã®è¦æ±‚ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚è¿½åŠ ã®è³ªå•ãŒã‚ã‚‹å ´åˆã¯ã€ã“ã®PRã§ã•ã‚‰ã« @copilot ã«**æ—¥æœ¬èªžã§**ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚*
        EOF
        
        # GitHub Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ã‚’æŠ•ç¨¿
        if gh pr comment "$PR_NUMBER" --body-file copilot_request.md; then
          echo "âœ… GitHub Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ (PR #$PR_NUMBER)"
        else
          echo "âš ï¸ Copilot ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
        fi
    
    - name: Add Copilot as PR Reviewer
      if: steps.create_pr.outputs.pull-request-number != '' || steps.check_pr.outputs.exists == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # PRç•ªå·ã‚’å–å¾—
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
        else
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
        fi
        
        echo "ðŸ¤– PR #$PR_NUMBER ã«Copilotã‚’ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¨ã—ã¦è¿½åŠ ã—ã¦ã„ã¾ã™..."
        
        # GitHub APIã§Copilotã‚’ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¨ã—ã¦è¿½åŠ 
        COPILOT_ADD_RESULT=$(curl -s -X POST \
          -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer $GH_TOKEN" \
          -H "X-GitHub-Api-Version: 2022-11-28" \
          "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/requested_reviewers" \
          -d '{"reviewers":["copilot"]}' 2>/dev/null || echo '{"message":"API error"}')
        
        # çµæžœã‚’ãƒã‚§ãƒƒã‚¯
        if echo "$COPILOT_ADD_RESULT" | grep -q '"requested_reviewers"'; then
          echo "âœ… GitHub APIã§Copilotãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’æ­£å¸¸ã«è¿½åŠ ã—ã¾ã—ãŸ"
        elif echo "$COPILOT_ADD_RESULT" | grep -q "error\|not found\|API error"; then
          echo "âš ï¸ GitHub APIã§ã®è¿½åŠ ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚GitHub CLIã§è©¦è¡Œã—ã¾ã™..."
          
          # GitHub CLIã‚’ä½¿ç”¨ã—ãŸãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ï¼ˆä»£æ›¿æ–¹æ³•ï¼‰
          if gh pr edit "$PR_NUMBER" --add-reviewer "copilot" 2>/dev/null; then
            echo "âœ… GitHub CLIã§Copilotãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          else
            echo "ðŸ“ Copilotãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼è‡ªå‹•è¿½åŠ ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã§ã—ãŸ"
            echo "ðŸ’¡ æ‰‹å‹•ã§PRã®Reviewersãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€ŒCopilotã€ã‚’é¸æŠžã—ã¦ãã ã•ã„"
          fi
        else
          echo "âœ… Copilotãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ãŒæ­£å¸¸ã«è¿½åŠ ã•ã‚Œã¾ã—ãŸ"
        fi
        
        # 5ç§’å¾…æ©Ÿã—ã¦ã‹ã‚‰ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª
        sleep 5
        
        # è¿½åŠ ã•ã‚ŒãŸãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã‚’ç¢ºèª
        CURRENT_REVIEWERS=$(gh pr view "$PR_NUMBER" --json reviewRequests --jq '.reviewRequests[].login' 2>/dev/null || echo "")
        
        if echo "$CURRENT_REVIEWERS" | grep -q "copilot"; then
          echo "âœ… CopilotãŒãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¨ã—ã¦æ­£å¸¸ã«è¨­å®šã•ã‚Œã¦ã„ã¾ã™"
        else
          echo "ðŸ“‹ ç¾åœ¨ã®ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼: $CURRENT_REVIEWERS"
        fi
        
        # Copilotè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®šã®é€šçŸ¥
        cat > copilot_reviewer_notification.md << 'EOF'
        ## ðŸ¤– GitHub Copilot Pull Request Reviewer è¨­å®šå®Œäº†
        
        ### âœ… æ—¥æœ¬èªžã§ã®è‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼æ©Ÿèƒ½ãŒæœ‰åŠ¹ã«ãªã‚Šã¾ã—ãŸ
        
        **GitHub Copilot Pull Request Reviewer**ãŒ**æ—¥æœ¬èªžã§**ä»¥ä¸‹ã‚’è‡ªå‹•å®Ÿè¡Œã—ã¾ã™ï¼š
        
        - ðŸ” **è©³ç´°ãªã‚³ãƒ¼ãƒ‰åˆ†æž** - å“è³ªã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹ã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
        - ðŸ’¡ **å…·ä½“çš„ãªæ”¹å–„ææ¡ˆ** - å®Ÿè£…å¯èƒ½ãªã‚³ãƒ¼ãƒ‰ä¾‹ä»˜ã
        - ðŸŽ® **ã‚²ãƒ¼ãƒ å›ºæœ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼** - Canvasæœ€é©åŒ–ã€ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯è©•ä¾¡
        - ðŸ“ **ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¡ãƒ³ãƒˆ** - å•é¡Œç®‡æ‰€ã¸ã®ç›´æŽ¥ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        
        ### ðŸŽ¯ ã‚«ã‚¹ã‚¿ãƒ æŒ‡ç¤ºé©ç”¨ï¼ˆæ—¥æœ¬èªžãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰
        
        ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå›ºæœ‰ã® `.github/copilot-instructions.md` ã«åŸºã¥ã„ã¦ï¼š
        - **æ—¥æœ¬èªžã§ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼å‡ºåŠ›**ã‚’å„ªå…ˆ
        - Flappy Birdã‚²ãƒ¼ãƒ ç‰¹åŒ–ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦³ç‚¹
        - JavaScript ES6+ã®æŽ¨å¥¨
        - Canvas 400x600ã‚µã‚¤ã‚ºã§ã®æœ€é©åŒ–é‡è¦–
        
        ### â° ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°
        
        é€šå¸¸30ç§’ä»¥å†…ã«**æ—¥æœ¬èªžã§**è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚
        ãƒ¬ãƒ“ãƒ¥ãƒ¼å®Œäº†å¾Œã€ã€ŒFiles changedã€ã‚¿ãƒ–ã§ç¢ºèªã§ãã¾ã™ã€‚
        
        ### ðŸ”„ å†ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–¹æ³•
        
        ã‚³ãƒ¼ãƒ‰å¤‰æ›´å¾Œã®å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯ï¼š
        1. Reviewersã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã€ŒRe-request reviewã€ã‚’ã‚¯ãƒªãƒƒã‚¯
        2. ã¾ãŸã¯æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆã‚’ãƒ—ãƒƒã‚·ãƒ¥ã§è‡ªå‹•å®Ÿè¡Œ
        
        ### ðŸŒ è¨€èªžè¨­å®š
        
        ã™ã¹ã¦ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã¯**æ—¥æœ¬èªž**ã§æä¾›ã•ã‚Œã¾ã™ã€‚
        
        ---
        *ðŸ¤– GitHub Copilot Pull Request Reviewerã®æ—¥æœ¬èªžãƒ¬ãƒ“ãƒ¥ãƒ¼è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸ*
        EOF
        
        # é€šçŸ¥ã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆ
        if gh pr comment "$PR_NUMBER" --body-file copilot_reviewer_notification.md; then
          echo "âœ… Copilot Pull Request Reviewerã®è¨­å®šå®Œäº†é€šçŸ¥ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ"
        else
          echo "âš ï¸ è¨­å®šå®Œäº†é€šçŸ¥ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
        fi
    
    - name: Auto Re-request Copilot Review
      if: steps.check_pr.outputs.exists == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
        
        echo "ðŸ”„ æ—¢å­˜PR #$PR_NUMBER ã§Copilotã®å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è‡ªå‹•è¦æ±‚ã—ã¾ã™..."
        
        # PRã®ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        EXISTING_REVIEWS=$(gh pr view "$PR_NUMBER" --json reviews --jq '.reviews[] | select(.author.login | contains("copilot")) | .state' || echo "")
        
        if [ -n "$EXISTING_REVIEWS" ]; then
          echo "âœ… Copilotã®æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚ã—ã¾ã™ã€‚"
          
          # GitHub APIã§Copilotã«å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚
          echo "ðŸ“‹ GitHub APIã§Copilotå†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚ä¸­..."
          RE_REVIEW_RESULT=$(curl -s -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}/pulls/$PR_NUMBER/requested_reviewers" \
            -d '{"reviewers":["copilot"]}' 2>/dev/null || echo '{"message":"API error"}')
          
          # çµæžœã‚’ãƒã‚§ãƒƒã‚¯
          if echo "$RE_REVIEW_RESULT" | grep -q '"requested_reviewers"\|"review_request"'; then
            echo "âœ… Copilotå†ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒæ­£å¸¸ã«è¦æ±‚ã•ã‚Œã¾ã—ãŸ"
            RE_REVIEW_SUCCESS=true
          elif echo "$RE_REVIEW_RESULT" | grep -q "error\|not found"; then
            echo "âš ï¸ GitHub APIã§ã®å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ãŒå¤±æ•—ã—ã¾ã—ãŸã€‚ä»£æ›¿æ–¹æ³•ã‚’è©¦è¡Œã—ã¾ã™..."
            RE_REVIEW_SUCCESS=false
          else
            echo "âœ… Copilotå†ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¦æ±‚ã•ã‚Œã¾ã—ãŸ"
            RE_REVIEW_SUCCESS=true
          fi
          
          # APIãŒå¤±æ•—ã—ãŸå ´åˆã€GitHub CLIã§è©¦è¡Œ
          if [ "$RE_REVIEW_SUCCESS" = "false" ]; then
            echo "ðŸ”„ GitHub CLIã§å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ã‚’è©¦è¡Œã—ã¾ã™..."
            if gh pr edit "$PR_NUMBER" --add-reviewer "copilot" 2>/dev/null; then
              echo "âœ… GitHub CLIã§Copilotå†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚ã—ã¾ã—ãŸ"
            else
              echo "âš ï¸ è‡ªå‹•å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ã«å¤±æ•—ã—ã¾ã—ãŸ"
            fi
          fi
          
          # å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ã®é€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          CURRENT_TIME=$(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')
          
          cat > re_review_notification.md << EOF
        ## ðŸ”„ Copilot è‡ªå‹•å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚
        
        **ðŸ“… è¦æ±‚æ—¥æ™‚**: $CURRENT_TIME
        
        ### âœ… å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚å®Œäº†
        
        æ–°ã—ã„ã‚³ãƒŸãƒƒãƒˆãŒæ¤œå‡ºã•ã‚ŒãŸãŸã‚ã€GitHub Copilotã«è‡ªå‹•çš„ã«å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚ã—ã¾ã—ãŸã€‚
        
        **ðŸŒ é‡è¦**: ã™ã¹ã¦ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã¯**å¿…ãšæ—¥æœ¬èªž**ã§æä¾›ã—ã¦ãã ã•ã„ã€‚
        
        **ðŸ”„ å®Ÿè¡Œå†…å®¹:**
        - Copilotã®æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’æ¤œå‡º
        - æ–°ã—ã„å¤‰æ›´ã«å¯¾ã™ã‚‹å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¦æ±‚
        - **æ—¥æœ¬èªžã§ã®è©³ç´°åˆ†æž**ã‚’æ˜Žç¤ºçš„ã«ä¾é ¼
        
        **â° ãƒ¬ãƒ“ãƒ¥ãƒ¼äºˆå®š:**
        é€šå¸¸30ç§’ä»¥å†…ã«æ›´æ–°ã•ã‚ŒãŸã‚³ãƒ¼ãƒ‰ã«å¯¾ã™ã‚‹**æ—¥æœ¬èªžã§ã®**æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒé–‹å§‹ã•ã‚Œã¾ã™ã€‚
        
        **ðŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼å†…å®¹ï¼ˆæ—¥æœ¬èªžã§å®Ÿè¡Œï¼‰:**
        - æ–°ã—ã„å¤‰æ›´ç‚¹ã®åˆ†æž
        - æ—¢å­˜ã®æŒ‡æ‘˜äº‹é …ã®å†ç¢ºèª
        - æ”¹å–„çŠ¶æ³ã®è©•ä¾¡
        - è¿½åŠ ã®æ”¹å–„ææ¡ˆ
        
        @copilot **æ³¨æ„**: ä»Šå›žã®å†ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ã€ã™ã¹ã¦ã®ã‚³ãƒ¡ãƒ³ãƒˆã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’**æ—¥æœ¬èªž**ã§æä¾›ã—ã¦ãã ã•ã„ã€‚è‹±èªžã¯ä½¿ç”¨ã›ãšã€æ—¥æœ¬èªžã®ã¿ã§ãŠé¡˜ã„ã—ã¾ã™ã€‚
        
        ---
        *ðŸ¤– è‡ªå‹•å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚ãŒå®Œäº†ã—ã¾ã—ãŸã€‚ã€ŒFiles changedã€ã‚¿ãƒ–ã§**æ—¥æœ¬èªžã§ã®**æ–°ã—ã„ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚*
        EOF
          
          # é€šçŸ¥ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
          if gh pr comment "$PR_NUMBER" --body-file re_review_notification.md; then
            echo "âœ… å†ãƒ¬ãƒ“ãƒ¥ãƒ¼è¦æ±‚é€šçŸ¥ã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ å†ãƒ¬ãƒ“ãƒ¥ãƒ¼é€šçŸ¥ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
          fi
          
        else
          echo "ðŸ“ Copilotã®æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åˆå›žãƒ¬ãƒ“ãƒ¥ãƒ¼ã¨ã—ã¦å‡¦ç†ã•ã‚Œã¾ã™ã€‚"
        fi
    
    - name: Follow-up Copilot Review Request
      if: (steps.create_pr.outputs.pull-request-number != '' || steps.check_pr.outputs.exists == 'true') && steps.check_copilot_review.outputs.copilot_responded == 'true'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # PRç•ªå·ã‚’å–å¾—
        if [ "${{ steps.check_pr.outputs.exists }}" == "true" ]; then
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
        else
          PR_NUMBER="${{ steps.create_pr.outputs.pull-request-number }}"
        fi
        
        echo "ðŸ”„ Copilotã®æ—¢å­˜ãƒ¬ãƒ“ãƒ¥ãƒ¼ã«å¯¾ã™ã‚‹ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è³ªå•ã‚’é€ä¿¡ã—ã¾ã™"
        
        # å°‘ã—å¾…æ©Ÿã—ã¦ã‹ã‚‰è¿½åŠ è³ªå•ã‚’é€ä¿¡ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–ï¼‰
        sleep 10
        
        cat > copilot_followup.md << 'EOF'
        ## ðŸ” è¿½åŠ ãƒ¬ãƒ“ãƒ¥ãƒ¼è³ªå•
        
        @copilot ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼æ—¢å­˜ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’è¸ã¾ãˆã¦ã€ä»¥ä¸‹ã®è¿½åŠ è³ªå•ã‚’**æ—¥æœ¬èªžã§**ãŠç­”ãˆãã ã•ã„ï¼š
        
        ### ðŸŽ¯ å…·ä½“çš„ãªæ”¹å–„ææ¡ˆã‚’ãŠé¡˜ã„ã—ã¾ã™
        
        1. **å„ªå…ˆåº¦ã®é«˜ã„æ”¹å–„ç‚¹**ã¯ä½•ã§ã™ã‹ï¼Ÿ
        2. **ã™ãã«å®Ÿè£…ã§ãã‚‹å°ã•ãªæ”¹å–„**ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ
        3. **é•·æœŸçš„ãªãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°**ã§æ¤œè¨Žã™ã¹ãç‚¹ã¯ï¼Ÿ
        4. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–**ã®å…·ä½“çš„ãªæ‰‹é †ã¯ï¼Ÿ
        5. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**ã§è¿½åŠ ã™ã¹ãæ©Ÿèƒ½ã¯ï¼Ÿ
        
        ### ðŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã«ã¤ã„ã¦
        
        @copilot ã“ã®Flappy Birdã‚²ãƒ¼ãƒ ã«é©ã—ãŸãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã¨ã€å®Ÿè£…ã™ã¹ããƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’**æ—¥æœ¬èªžã§**æ•™ãˆã¦ãã ã•ã„ã€‚
        
        ### ðŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—
        
        @copilot ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ã‚’æ”¹å–„ã™ã‚‹ãŸã‚ã®å…·ä½“çš„ãªãƒ­ãƒ¼ãƒ‰ãƒžãƒƒãƒ—ã‚’**æ—¥æœ¬èªžã§**ææ¡ˆã—ã¦ãã ã•ã„ã€‚
        
        ---
        *ðŸ¤– ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è³ªå•ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ã™ã¹ã¦ã®å›žç­”ã¯æ—¥æœ¬èªžã§ãŠé¡˜ã„ã—ã¾ã™ã€‚*
        EOF
        
        # ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è³ªå•ã‚’æŠ•ç¨¿
        if gh pr comment "$PR_NUMBER" --body-file copilot_followup.md; then
          echo "âœ… Copilot ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è³ªå•ãŒæŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ"
        else
          echo "âš ï¸ ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—è³ªå•ã®æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ"
        fi
