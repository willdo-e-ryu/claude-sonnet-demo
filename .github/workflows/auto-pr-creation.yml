name: Auto PR Creation

on:
  push:
    branches-ignore:
      - main
      - master
      - develop
  # feature/fix/ãªã©ã®ãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«å®Ÿè¡Œ

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-pr:
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master' && github.ref != 'refs/heads/develop'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get branch info
      id: branch_info
      run: |
        BRANCH_NAME=${GITHUB_REF#refs/heads/}
        BASE_BRANCH="master"
        
        # developãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã¡ã‚‰ã‚’å„ªå…ˆ
        if git show-ref --verify --quiet refs/remotes/origin/develop; then
          BASE_BRANCH="develop"
        # mainãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹å ´åˆ
        elif git show-ref --verify --quiet refs/remotes/origin/main; then
          BASE_BRANCH="main"
        fi
        
        echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
        echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT
        echo "pr_title=ðŸ”„ Auto PR: $BRANCH_NAME" >> $GITHUB_OUTPUT
    
    - name: Check if PR already exists
      id: check_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
        BASE_BRANCH="${{ steps.branch_info.outputs.base_branch }}"
        
        # æ—¢å­˜ã®PRã‚’ãƒã‚§ãƒƒã‚¯
        PR_NUMBER=$(gh pr list --head "$BRANCH_NAME" --base "$BASE_BRANCH" --json number --jq '.[0].number // empty' || echo "")
        
        if [ -n "$PR_NUMBER" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "æ—¢å­˜ã®PR #$PR_NUMBER ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ - ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "æ–°ã—ã„PRã‚’ä½œæˆã—ã¾ã™"
        fi
    
    - name: Generate commit summary
      if: steps.check_pr.outputs.exists == 'false'
      id: commit_summary
      run: |
        BASE_BRANCH="${{ steps.branch_info.outputs.base_branch }}"
        
        # ã‚³ãƒŸãƒƒãƒˆã®å·®åˆ†ã‚’å–å¾—
        COMMITS=$(git log --oneline origin/$BASE_BRANCH..HEAD | head -10)
        FILES_CHANGED=$(git diff --name-only origin/$BASE_BRANCH..HEAD | head -20)
        
        # ã‚·ãƒ³ãƒ—ãƒ«ãªPRæœ¬æ–‡ã‚’ç”Ÿæˆ
        {
          echo "## ðŸ“ å¤‰æ›´å†…å®¹"
          echo ""
          echo "**å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:**"
          echo '```'
          echo "$FILES_CHANGED"
          echo '```'
          echo ""
          echo "**ã‚³ãƒŸãƒƒãƒˆå±¥æ­´:**"
          echo '```'
          echo "$COMMITS"
          echo '```'
        } > pr_body.md
    
    - name: Create Pull Request
      if: steps.check_pr.outputs.exists == 'false'
      id: create_pr
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        BRANCH_NAME="${{ steps.branch_info.outputs.branch_name }}"
        BASE_BRANCH="${{ steps.branch_info.outputs.base_branch }}"
        PR_TITLE="${{ steps.branch_info.outputs.pr_title }}"
        
        # GitHub CLI ã§PRã‚’ä½œæˆ
        PR_URL=$(gh pr create \
          --title "$PR_TITLE" \
          --body-file pr_body.md \
          --base "$BASE_BRANCH" \
          --head "$BRANCH_NAME" \
          --repo ${{ github.repository }})
        
        # PRç•ªå·ã‚’æŠ½å‡º
        PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]\+$')
        
        echo "âœ… PR #$PR_NUMBER ãŒä½œæˆã•ã‚Œã¾ã—ãŸ: $PR_URL"
        echo "pull-request-number=$PR_NUMBER" >> $GITHUB_OUTPUT
        echo "pull-request-url=$PR_URL" >> $GITHUB_OUTPUT
