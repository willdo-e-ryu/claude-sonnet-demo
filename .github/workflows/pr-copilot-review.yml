name: PR Code Review with Copilot

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [ main, master, develop ]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Get changed files
      id: changed_files
      run: |
        # PRã§å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        git fetch origin ${{ github.event.pull_request.base.ref }}
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD)
        
        echo "changed_files<<EOF" >> $GITHUB_OUTPUT
        echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
        # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’æŠ½å‡º
        JS_FILES=$(echo "$CHANGED_FILES" | grep '\.js$' || echo "")
        echo "js_files<<EOF" >> $GITHUB_OUTPUT
        echo "$JS_FILES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Analyze JavaScript files
      if: steps.changed_files.outputs.js_files != ''
      id: js_analysis
      run: |
        echo "## ğŸ¤– GitHub Copilot ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼è©³ç´°åˆ†æ" > detailed_review.md
        echo "" >> detailed_review.md
        echo "ä»¥ä¸‹ã®JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦è©³ç´°åˆ†æã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼š" >> detailed_review.md
        echo "" >> detailed_review.md
        
        while IFS= read -r file; do
          if [ -f "$file" ] && [ -n "$file" ]; then
            echo "### ğŸ“„ \`$file\`" >> detailed_review.md
            echo "" >> detailed_review.md
            
            # ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æƒ…å ±
            FILE_SIZE=$(wc -c < "$file")
            LINE_COUNT=$(wc -l < "$file")
            
            echo "**ğŸ“Š åŸºæœ¬ãƒ¡ãƒˆãƒªã‚¯ã‚¹:**" >> detailed_review.md
            echo "- ã‚µã‚¤ã‚º: ${FILE_SIZE} bytes" >> detailed_review.md
            echo "- è¡Œæ•°: ${LINE_COUNT} è¡Œ" >> detailed_review.md
            
            # é–¢æ•°åˆ†æ
            FUNCTIONS=$(grep -n "function\|const.*=>\|class " "$file" | head -5)
            if [ -n "$FUNCTIONS" ]; then
              echo "" >> detailed_review.md
              echo "**ğŸ”§ é–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹å®šç¾©:**" >> detailed_review.md
              echo '```javascript' >> detailed_review.md
              echo "$FUNCTIONS" | cut -d: -f2- | sed 's/^[ \t]*//' >> detailed_review.md
              echo '```' >> detailed_review.md
            fi
            
            # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
            echo "" >> detailed_review.md
            echo "**âœ… å“è³ªãƒã‚§ãƒƒã‚¯çµæœ:**" >> detailed_review.md
            
            # ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãƒã‚§ãƒƒã‚¯
            if grep -q "try\|catch\|throw" "$file"; then
              echo "- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™" >> detailed_review.md
            else
              echo "- âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®è¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„" >> detailed_review.md
            fi
            
            # ã‚³ãƒ¡ãƒ³ãƒˆã®å­˜åœ¨ç¢ºèª
            COMMENT_COUNT=$(grep -c "^\s*//\|^\s*/\*\|\*" "$file" || echo "0")
            if [ "$COMMENT_COUNT" -gt 5 ]; then
              echo "- âœ… ååˆ†ãªã‚³ãƒ¡ãƒ³ãƒˆãŒè¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ ($COMMENT_COUNT è¡Œ)" >> detailed_review.md
            else
              echo "- ğŸ’¡ ã‚ˆã‚Šè©³ç´°ãªã‚³ãƒ¡ãƒ³ãƒˆã®è¿½åŠ ã‚’æ¨å¥¨ã—ã¾ã™ ($COMMENT_COUNT è¡Œ)" >> detailed_review.md
            fi
            
            # ESãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®ä½¿ç”¨ç¢ºèª
            if grep -q "import\|export" "$file"; then
              echo "- âœ… ES Modulesã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™" >> detailed_review.md
            fi
            
            # å®šæ•°ã®ä½¿ç”¨ç¢ºèª
            if grep -q "const CONFIG\|CONFIG\." "$file"; then
              echo "- âœ… è¨­å®šå®šæ•°ã‚’é©åˆ‡ã«ä½¿ç”¨ã—ã¦ã„ã¾ã™" >> detailed_review.md
            fi
            
            # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
            SECURITY_ISSUES=""
            if grep -q "innerHTML" "$file"; then
              SECURITY_ISSUES="${SECURITY_ISSUES}- âš ï¸ innerHTML ã®ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚XSSå¯¾ç­–ã‚’ç¢ºèªã—ã¦ãã ã•ã„\n"
            fi
            if grep -q "eval\|Function(" "$file"; then
              SECURITY_ISSUES="${SECURITY_ISSUES}- ğŸš¨ eval() ã®ä½¿ç”¨ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒªã‚¹ã‚¯ã‚’æ¤œè¨ã—ã¦ãã ã•ã„\n"
            fi
            if [ -n "$SECURITY_ISSUES" ]; then
              echo "" >> detailed_review.md
              echo "**ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„ç‚¹:**" >> detailed_review.md
              echo -e "$SECURITY_ISSUES" >> detailed_review.md
            fi
            
            # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ææ¡ˆ
            echo "" >> detailed_review.md
            echo "**ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ææ¡ˆ:**" >> detailed_review.md
            
            if grep -q "querySelector\|getElementById" "$file"; then
              echo "- ğŸ’¡ DOMè¦ç´ ã®å–å¾—ã¯ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„" >> detailed_review.md
            fi
            
            if grep -q "setInterval\|setTimeout" "$file" && grep -q "requestAnimationFrame" "$file"; then
              echo "- âœ… requestAnimationFrameã‚’ä½¿ç”¨ã—ãŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶å¾¡ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™" >> detailed_review.md
            fi
            
            echo "" >> detailed_review.md
            echo "---" >> detailed_review.md
            echo "" >> detailed_review.md
          fi
        done < <(echo "${{ steps.changed_files.outputs.js_files }}")
    
    - name: Analyze other file types
      run: |
        echo "" >> detailed_review.md
        echo "## ğŸ” ãã®ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ" >> detailed_review.md
        echo "" >> detailed_review.md
        
        # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
        HTML_FILES=$(echo "${{ steps.changed_files.outputs.changed_files }}" | grep '\.html$' || echo "")
        if [ -n "$HTML_FILES" ]; then
          echo "### ğŸ“„ HTMLãƒ•ã‚¡ã‚¤ãƒ«" >> detailed_review.md
          while IFS= read -r file; do
            if [ -f "$file" ] && [ -n "$file" ]; then
              echo "- **$file**:" >> detailed_review.md
              
              # ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTMLã®ä½¿ç”¨ç¢ºèª
              if grep -q "section\|article\|nav\|header\|footer\|main" "$file"; then
                echo "  - âœ… ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTMLã‚’ä½¿ç”¨" >> detailed_review.md
              fi
              
              # ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
              if grep -q "alt=\|aria-\|role=" "$file"; then
                echo "  - âœ… ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å±æ€§ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™" >> detailed_review.md
              else
                echo "  - ğŸ’¡ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å±æ€§ã®è¿½åŠ ã‚’æ¤œè¨ã—ã¦ãã ã•ã„" >> detailed_review.md
              fi
            fi
          done < <(echo "$HTML_FILES")
          echo "" >> detailed_review.md
        fi
        
        # CSSãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ†æ
        CSS_FILES=$(echo "${{ steps.changed_files.outputs.changed_files }}" | grep '\.css$' || echo "")
        if [ -n "$CSS_FILES" ]; then
          echo "### ğŸ¨ CSSãƒ•ã‚¡ã‚¤ãƒ«" >> detailed_review.md
          while IFS= read -r file; do
            if [ -f "$file" ] && [ -n "$file" ]; then
              echo "- **$file**:" >> detailed_review.md
              
              # ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®ç¢ºèª
              if grep -q "@media" "$file"; then
                echo "  - âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™" >> detailed_review.md
              fi
              
              # CSS Grid/Flexboxã®ä½¿ç”¨ç¢ºèª
              if grep -q "display:\s*flex\|display:\s*grid" "$file"; then
                echo "  - âœ… ãƒ¢ãƒ€ãƒ³ãªãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæŠ€è¡“ã‚’ä½¿ç”¨" >> detailed_review.md
              fi
            fi
          done < <(echo "$CSS_FILES")
          echo "" >> detailed_review.md
        fi
    
    - name: Generate Copilot suggestions
      run: |
        echo "" >> detailed_review.md
        echo "## ğŸ’¡ GitHub Copilot ã‹ã‚‰ã®æ”¹å–„ææ¡ˆ" >> detailed_review.md
        echo "" >> detailed_review.md
        echo "### ğŸ¯ ä¸€èˆ¬çš„ãªæ”¹å–„ãƒã‚¤ãƒ³ãƒˆ" >> detailed_review.md
        echo "" >> detailed_review.md
        echo "1. **ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§**" >> detailed_review.md
        echo "   - å¤‰æ•°åã‚„é–¢æ•°åã‚’ã‚ˆã‚Šèª¬æ˜çš„ã«ã™ã‚‹" >> detailed_review.md
        echo "   - è¤‡é›‘ãªå‡¦ç†ã«ã¯ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹" >> detailed_review.md
        echo "" >> detailed_review.md
        echo "2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**" >> detailed_review.md
        echo "   - try-catch ãƒ–ãƒ­ãƒƒã‚¯ã®é©åˆ‡ãªä½¿ç”¨" >> detailed_review.md
        echo "   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸" >> detailed_review.md
        echo "" >> detailed_review.md
        echo "3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**" >> detailed_review.md
        echo "   - ä¸è¦ãªå†è¨ˆç®—ã®å‰Šæ¸›" >> detailed_review.md
        echo "   - DOMæ“ä½œã®æœ€å°åŒ–" >> detailed_review.md
        echo "   - é©åˆ‡ãªãƒ‡ãƒ¼ã‚¿æ§‹é€ ã®é¸æŠ" >> detailed_review.md
        echo "" >> detailed_review.md
        echo "4. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**" >> detailed_review.md
        echo "   - å…¥åŠ›å€¤ã®æ¤œè¨¼" >> detailed_review.md
        echo "   - XSSæ”»æ’ƒã®é˜²æ­¢" >> detailed_review.md
        echo "   - æ©Ÿå¯†æƒ…å ±ã®é©åˆ‡ãªå‡¦ç†" >> detailed_review.md
        echo "" >> detailed_review.md
        echo "### ğŸš€ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—" >> detailed_review.md
        echo "" >> detailed_review.md
        echo "- [ ] ä¸Šè¨˜ã®ææ¡ˆã‚’æ¤œè¨ãƒ»å®Ÿè£…" >> detailed_review.md
        echo "- [ ] ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã®è¿½åŠ ãƒ»å®Ÿè¡Œ" >> detailed_review.md
        echo "- [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°" >> detailed_review.md
        echo "- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ" >> detailed_review.md
        echo "" >> detailed_review.md
        echo "---" >> detailed_review.md
        echo "ğŸ¤– **ã“ã®åˆ†æã¯ GitHub Copilot ã®æ”¯æ´ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚**" >> detailed_review.md
        echo "ã•ã‚‰ã«è©³ç´°ãªãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¿…è¦ãªå ´åˆã¯ã€PRå†…ã§ \`@github-actions\` ã«ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã—ã¦ãã ã•ã„ã€‚" >> detailed_review.md
    
    - name: Post detailed review
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh pr comment ${{ github.event.pull_request.number }} --body-file detailed_review.md
        echo "âœ… è©³ç´°ãªã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’PRã«æŠ•ç¨¿ã—ã¾ã—ãŸ"
    
    - name: Add review summary to PR
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cat > review_summary.md << 'EOF'
        ## ğŸ“‹ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚µãƒãƒªãƒ¼
        
        ğŸ¤– **GitHub Copilotè‡ªå‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå®Œäº†ã—ã¾ã—ãŸï¼**
        
        ### ğŸ“Š åˆ†ææ¸ˆã¿é …ç›®
        - âœ… ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
        - âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„†å¼±æ€§ãƒã‚§ãƒƒã‚¯  
        - âœ… ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®æ©Ÿä¼š
        - âœ… ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ã¨UX
        - âœ… ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ã¨ä¿å®ˆæ€§
        
        ### ğŸ¯ ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
        ä¸Šè¨˜ã®è©³ç´°åˆ†æã‚’ç¢ºèªã—ã€ææ¡ˆã•ã‚ŒãŸæ”¹å–„ç‚¹ã‚’æ¤œè¨ã—ã¦ãã ã•ã„ã€‚
        
        **äººé–“ã®ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã®çš†ã•ã¾**: 
        è‡ªå‹•åˆ†æã«åŠ ãˆã¦ã€ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ã‚¯ã‚¹ãƒšãƒªã‚¨ãƒ³ã‚¹ã®è¦³ç‚¹ã‹ã‚‰ã‚‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
        
        ---
        ğŸ’¬ è³ªå•ã‚„è¿½åŠ ã®åˆ†æãŒå¿…è¦ãªå ´åˆã¯ã€ã‚³ãƒ¡ãƒ³ãƒˆã§ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚
        EOF
        
        gh pr comment ${{ github.event.pull_request.number }} --body-file review_summary.md
