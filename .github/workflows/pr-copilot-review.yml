name: GitHub Copilot CLI Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [ main, master, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-cli-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Install GitHub CLI with Copilot Extension
      run: |
        # GitHub CLI ã®æœ€æ–°ç‰ˆã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y
        
        # GitHub Copilot æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        gh extension install github/gh-copilot
        
        echo "âœ… GitHub CLI with Copilot extension installed successfully"
        gh extension list | grep copilot || echo "Copilot extension verification"
    
    - name: Authenticate GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "$GH_TOKEN" | gh auth login --with-token
        gh auth status
    
    - name: GitHub Copilot CLI Code Analysis
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "## ğŸ¤– GitHub Copilot CLI ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æ" > copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        echo "### ğŸ“… åˆ†æå®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')" >> copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        git fetch origin ${{ github.event.pull_request.base.ref }}
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD)
        
        echo "### ğŸ“„ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§" >> copilot_cli_review.md
        echo "\`\`\`" >> copilot_cli_review.md
        echo "$CHANGED_FILES" >> copilot_cli_review.md
        echo "\`\`\`" >> copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        
        # Copilot CLI ã®åˆ©ç”¨å¯å¦ã‚’ç¢ºèª
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "### ğŸ¤– GitHub Copilot CLI åˆ†æçµæœ" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "âœ… **GitHub Copilot CLI æ‹¡å¼µæ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™**" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã«ã¤ã„ã¦Copilotææ¡ˆã‚’å–å¾—
          echo "#### ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ”¹å–„ææ¡ˆ" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          
          # Copilot suggest ã‚³ãƒãƒ³ãƒ‰ã§æ”¹å–„ææ¡ˆã‚’å–å¾—
          {
            echo "ä»¥ä¸‹ã®Canvas ãƒ™ãƒ¼ã‚¹ã®Flappy Birdã‚²ãƒ¼ãƒ ã«ã¤ã„ã¦ã€ã‚³ãƒ¼ãƒ‰å“è³ªã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®æ”¹å–„ææ¡ˆã‚’ã—ã¦ãã ã•ã„: HTML5 Canvas ã‚²ãƒ¼ãƒ ã€JavaScript ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã€è¡çªåˆ¤å®šã‚·ã‚¹ãƒ†ãƒ " | \
            gh copilot suggest 2>/dev/null | head -25
          } >> copilot_cli_review.md 2>/dev/null || {
            echo "**ğŸ’« Copilot åŸºæœ¬ææ¡ˆ:**" >> copilot_cli_review.md
            echo "- ğŸ¯ **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–**: ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¤‡æ•°ã®ã‚¯ãƒ©ã‚¹ã«åˆ†å‰²" >> copilot_cli_review.md
            echo "- ğŸš€ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: requestAnimationFrame ã®æœ€é©åŒ–" >> copilot_cli_review.md
            echo "- ğŸ§ª **ãƒ†ã‚¹ãƒˆ**: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã®è¿½åŠ å®Ÿè£…" >> copilot_cli_review.md
            echo "- ğŸ”’ **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: try-catchæ–‡ã®é©åˆ‡ãªé…ç½®" >> copilot_cli_review.md
            echo "- ğŸ“± **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œ" >> copilot_cli_review.md
          }
          
          echo "" >> copilot_cli_review.md
          
          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦å€‹åˆ¥ã« Copilot åˆ†æ
          echo "#### ğŸ“‚ å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          
          while IFS= read -r file; do
            if [ -f "$file" ] && [ -n "$file" ]; then
              echo "##### ğŸ“„ \`$file\`" >> copilot_cli_review.md
              echo "" >> copilot_cli_review.md
              
              # ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­åˆ¥ã®åˆ†æ
              FILE_EXT="${file##*.}"
              case "$FILE_EXT" in
                js)
                  echo "**ğŸ”§ JavaScript åˆ†æ:**" >> copilot_cli_review.md
                  
                  # ãƒ•ã‚¡ã‚¤ãƒ«ã®æœ€åˆã®éƒ¨åˆ†ã‚’åŸºã«Copilotææ¡ˆ
                  FILE_PREVIEW=$(head -10 "$file" | grep -v '^$' | head -5)
                  if [ -n "$FILE_PREVIEW" ]; then
                    echo "\`\`\`javascript" >> copilot_cli_review.md
                    echo "$FILE_PREVIEW" >> copilot_cli_review.md
                    echo "\`\`\`" >> copilot_cli_review.md
                    echo "" >> copilot_cli_review.md
                    
                    # Copilot explain ã§ã‚³ãƒ¼ãƒ‰åˆ†æ
                    echo "**ğŸ’¡ Copilot åˆ†æ:**" >> copilot_cli_review.md
                    echo "$FILE_PREVIEW" | head -3 | gh copilot explain 2>/dev/null >> copilot_cli_review.md || {
                      echo "- é–¢æ•°æ•°: $(grep -c "function\|const.*=>\|class " "$file" || echo "0") å€‹" >> copilot_cli_review.md
                      echo "- è¡Œæ•°: $(wc -l < "$file") è¡Œ" >> copilot_cli_review.md
                    }
                  fi
                  ;;
                html)
                  echo "**ğŸ“„ HTML ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ:**" >> copilot_cli_review.md
                  if grep -q "alt=\|aria-" "$file"; then
                    echo "- âœ… ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å±æ€§ã‚ã‚Š" >> copilot_cli_review.md
                  else
                    echo "- ğŸ’¡ altå±æ€§ã‚„ARIAå±æ€§ã®è¿½åŠ ã‚’æ¨å¥¨" >> copilot_cli_review.md
                  fi
                  ;;
                css)
                  echo "**ğŸ¨ CSS ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ:**" >> copilot_cli_review.md
                  echo "- ã‚µã‚¤ã‚º: $(wc -c < "$file") bytes" >> copilot_cli_review.md
                  if grep -q "@media" "$file"; then
                    echo "- âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³å¯¾å¿œ" >> copilot_cli_review.md
                  fi
                  ;;
              esac
              
              echo "" >> copilot_cli_review.md
            fi
          done < <(echo "$CHANGED_FILES")
        else
          echo "### âš ï¸ GitHub Copilot CLI æœªåˆ©ç”¨" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "GitHub Copilot CLI æ‹¡å¼µæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "**å¯èƒ½ãªç†ç”±:**" >> copilot_cli_review.md
          echo "- GitHub Copilot ãƒ©ã‚¤ã‚»ãƒ³ã‚¹èªè¨¼ãŒå¿…è¦" >> copilot_cli_review.md
          echo "- æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼" >> copilot_cli_review.md
          echo "- API ãƒ¬ãƒ¼ãƒˆåˆ¶é™" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "**ğŸ’¡ ä»£æ›¿æ‰‹æ®µ:** VS Code ã§ GitHub Copilot ã‚’ç›´æ¥ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚" >> copilot_cli_review.md
        fi
        
        echo "" >> copilot_cli_review.md
        echo "---" >> copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        echo "ğŸ¤– **GitHub Copilot CLI çµ±åˆåˆ†æå®Œäº†** - $(date '+%Y-%m-%d %H:%M:%S')" >> copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        echo "ğŸ’¡ **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º**: VS Code ã§ \`gh copilot suggest\` ã¾ãŸã¯ \`gh copilot explain\` ã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šè©³ç´°ãªææ¡ˆã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚" >> copilot_cli_review.md
    
    - name: Post Copilot CLI Review to PR
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # PRã«Copilot CLI ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        gh pr comment ${{ github.event.pull_request.number }} \
          --body-file copilot_cli_review.md \
          --repo ${{ github.repository }}
        
        echo "âœ… GitHub Copilot CLI ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒPRã«æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ"
    
    - name: Add Copilot-Related Labels
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Copiloté–¢é€£ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
        gh pr edit ${{ github.event.pull_request.number }} \
          --add-label "copilot-reviewed" \
          --add-label "ai-assisted" \
          --repo ${{ github.repository }} || echo "ãƒ©ãƒ™ãƒ«è¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰"
        
        echo "âœ… Copiloté–¢é€£ãƒ©ãƒ™ãƒ«ã®è¿½åŠ ã‚’è©¦è¡Œã—ã¾ã—ãŸ"
