name: GitHub Copilot CLI Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches: [ main, master, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  copilot-cli-review:
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    
    steps:
    - name: Checkout PR code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        ref: ${{ github.event.pull_request.head.sha }}
    
    - name: Setup GitHub CLI and Authenticate
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHub CLI ã¯ ubuntu-latest ã«æ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
        echo "GitHub CLI version: $(gh --version)"
        
        # ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        if [ -z "$GH_TOKEN" ]; then
          echo "âŒ GH_TOKEN environment variable is not set"
          exit 1
        fi
        
        # GitHub CLI èªè¨¼ï¼ˆç’°å¢ƒå¤‰æ•°æ–¹å¼ï¼‰
        export GH_TOKEN="$GH_TOKEN"
        
        # èªè¨¼çŠ¶æ…‹ã‚’ç¢ºèª
        if gh auth status 2>/dev/null; then
          echo "âœ… GitHub CLI authentication successful via GH_TOKEN"
        else
          echo "âš ï¸ Authentication check failed, but GH_TOKEN is set - proceeding"
        fi
    
    - name: Install GitHub Copilot Extension
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHub Copilot æ‹¡å¼µæ©Ÿèƒ½ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        echo "ğŸ” Checking for existing Copilot extension..."
        
        if gh extension list 2>/dev/null | grep -q "gh-copilot"; then
          echo "âœ… GitHub Copilot extension already installed"
        else
          echo "ğŸ“¦ Installing GitHub Copilot extension..."
          if gh extension install github/gh-copilot 2>/dev/null; then
            echo "âœ… GitHub Copilot extension installed successfully"
          else
            echo "âš ï¸ Copilot extension installation failed"
            echo "Possible reasons:"
            echo "- GitHub Copilot license required"
            echo "- Network connectivity issues"
            echo "- Extension not available in this environment"
          fi
        fi
        
        # æ‹¡å¼µæ©Ÿèƒ½ãƒªã‚¹ãƒˆã‚’ç¢ºèª
        echo ""
        echo "ğŸ“‹ Installed extensions:"
        gh extension list 2>/dev/null || echo "No extensions found or access denied"
        
        # Copilot ã‚³ãƒãƒ³ãƒ‰ã®åˆ©ç”¨å¯èƒ½æ€§ã‚’ãƒ†ã‚¹ãƒˆ
        echo ""
        echo "ğŸ§ª Testing Copilot CLI availability..."
        if command -v gh >/dev/null 2>&1 && gh copilot --help >/dev/null 2>&1; then
          echo "âœ… GitHub Copilot CLI is ready and available"
          echo "COPILOT_AVAILABLE=true" >> $GITHUB_ENV
        else
          echo "âš ï¸ GitHub Copilot CLI not available - will use fallback analysis"
          echo "COPILOT_AVAILABLE=false" >> $GITHUB_ENV
        fi
    
    - name: GitHub Copilot CLI Code Analysis
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "## ğŸ¤– GitHub Copilot CLI ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ†æ" > copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        echo "### ğŸ“… åˆ†æå®Ÿè¡Œæ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')" >> copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        
        # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
        git fetch origin ${{ github.event.pull_request.base.ref }}
        CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD)
        
        echo "### ğŸ“„ å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§" >> copilot_cli_review.md
        echo "\`\`\`" >> copilot_cli_review.md
        echo "$CHANGED_FILES" >> copilot_cli_review.md
        echo "\`\`\`" >> copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        
        # Copilot CLI ã®åˆ©ç”¨å¯å¦ã‚’ç¢ºèª
        echo "ğŸ” Checking Copilot CLI availability..."
        
        if [ "$COPILOT_AVAILABLE" = "true" ]; then
          echo "### ğŸ¤– GitHub Copilot CLI åˆ†æçµæœ" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "âœ… **GitHub Copilot CLI æ‹¡å¼µæ©Ÿèƒ½ãŒåˆ©ç”¨å¯èƒ½ã§ã™**" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
        else
          echo "### âš ï¸ GitHub Copilot CLI åˆ¶é™ãƒ¢ãƒ¼ãƒ‰" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "âš ï¸ **GitHub Copilot CLI æ‹¡å¼µæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“**" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "**ç†ç”±ã®å¯èƒ½æ€§:**" >> copilot_cli_review.md
          echo "- GitHub Copilot ãƒ©ã‚¤ã‚»ãƒ³ã‚¹èªè¨¼ãŒå¿…è¦" >> copilot_cli_review.md
          echo "- æ‹¡å¼µæ©Ÿèƒ½ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¤±æ•—" >> copilot_cli_review.md
          echo "- GitHub Actions ç’°å¢ƒåˆ¶é™" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
        fi
        
        echo "" >> copilot_cli_review.md
          
          # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã«ã¤ã„ã¦Copilotææ¡ˆã‚’å–å¾—
          echo "#### ğŸ¯ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ”¹å–„ææ¡ˆ" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          
          # Copilot ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿è©³ç´°ææ¡ˆã‚’å–å¾—
          if [ "$COPILOT_AVAILABLE" = "true" ]; then
            echo "**ğŸ¤– GitHub Copilot ã‹ã‚‰ã®ææ¡ˆ:**" >> copilot_cli_review.md
            echo "" >> copilot_cli_review.md
            
            # Copilot suggest ã‚³ãƒãƒ³ãƒ‰ã§æ”¹å–„ææ¡ˆã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
            if timeout 30s gh copilot suggest "Canvas ãƒ™ãƒ¼ã‚¹ã®Flappy Birdã‚²ãƒ¼ãƒ ã®ã‚³ãƒ¼ãƒ‰å“è³ªæ”¹å–„ã«ã¤ã„ã¦ææ¡ˆã—ã¦ãã ã•ã„" 2>/dev/null | head -15 >> copilot_cli_review.md; then
              echo "" >> copilot_cli_review.md
            else
              echo "- âš ï¸ Copilot API ãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯ãƒ¬ãƒ¼ãƒˆåˆ¶é™ï¼‰" >> copilot_cli_review.md
              echo "" >> copilot_cli_review.md
            fi
          fi
          
          # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ææ¡ˆï¼ˆCopilotåˆ©ç”¨ä¸å¯æ™‚ã¾ãŸã¯è£œå®Œã¨ã—ã¦ï¼‰
          if [ "$COPILOT_AVAILABLE" != "true" ]; then
            echo "**ğŸ’« åŸºæœ¬çš„ãªæ”¹å–„ææ¡ˆ:**" >> copilot_cli_review.md
          else
            echo "**ğŸ’« è¿½åŠ ã®æ”¹å–„ææ¡ˆ:**" >> copilot_cli_review.md
          fi
          
          echo "- ğŸ¯ **ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«åŒ–**: ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¤‡æ•°ã®ã‚¯ãƒ©ã‚¹ã«åˆ†å‰²" >> copilot_cli_review.md
          echo "- ğŸš€ **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: requestAnimationFrame ã®æœ€é©åŒ–" >> copilot_cli_review.md
          echo "- ğŸ§ª **ãƒ†ã‚¹ãƒˆ**: Jest ã«ã‚ˆã‚‹ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆè¿½åŠ " >> copilot_cli_review.md
          echo "- ğŸ”’ **ã‚¨ãƒ©ãƒ¼å‡¦ç†**: try-catchæ–‡ã®é©åˆ‡ãªé…ç½®" >> copilot_cli_review.md
          echo "- ğŸ“± **ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£**: ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œå¯¾å¿œ" >> copilot_cli_review.md
          
          echo "" >> copilot_cli_review.md
          
          # å„ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¤ã„ã¦å€‹åˆ¥ã«åˆ†æ
          echo "#### ğŸ“‚ å€‹åˆ¥ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          
          while IFS= read -r file; do
            if [ -f "$file" ] && [ -n "$file" ]; then
              echo "##### ğŸ“„ \`$file\`" >> copilot_cli_review.md
              echo "" >> copilot_cli_review.md
              
              # ãƒ•ã‚¡ã‚¤ãƒ«æ‹¡å¼µå­åˆ¥ã®åˆ†æ
              FILE_EXT="${file##*.}"
              case "$FILE_EXT" in
                js)
                  echo "**ğŸ”§ JavaScript åˆ†æ:**" >> copilot_cli_review.md
                  
                  # ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬åˆ†æï¼ˆCopilotåˆ©ç”¨å¯å¦ã«é–¢ã‚ã‚‰ãšï¼‰
                  LINE_COUNT=$(wc -l < "$file")
                  FUNCTION_COUNT=$(grep -c "function\|const.*=>\|class " "$file" || echo "0")
                  
                  echo "- ğŸ“Š è¡Œæ•°: $LINE_COUNT è¡Œ" >> copilot_cli_review.md
                  echo "- ğŸ”§ é–¢æ•°ãƒ»ã‚¯ãƒ©ã‚¹æ•°: $FUNCTION_COUNT å€‹" >> copilot_cli_review.md
                  
                  # Copilot ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿å®Ÿè¡Œ
                  if [ "$COPILOT_AVAILABLE" = "true" ]; then
                    FILE_PREVIEW=$(head -5 "$file" | grep -v '^$' | head -3)
                    if [ -n "$FILE_PREVIEW" ]; then
                      echo "" >> copilot_cli_review.md
                      echo "**ğŸ’¡ Copilot ææ¡ˆ:**" >> copilot_cli_review.md
                      
                      # Copilot explain ã§ã‚³ãƒ¼ãƒ‰åˆ†æï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
                      if timeout 20s bash -c "echo '$FILE_PREVIEW' | gh copilot explain 2>/dev/null" | head -8 >> copilot_cli_review.md; then
                        echo "" >> copilot_cli_review.md
                      else
                        echo "- Copilot åˆ†æã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¾ãŸã¯APIåˆ¶é™ã«ã‚ˆã‚Šä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“" >> copilot_cli_review.md
                        echo "" >> copilot_cli_review.md
                      fi
                    fi
                  fi
                  
                  # åŸºæœ¬çš„ãªã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆå¸¸ã«å®Ÿè¡Œï¼‰
                  if grep -q "console\.log" "$file"; then
                    echo "- âš ï¸ console.log æ®‹å­˜ï¼ˆæœ¬ç•ªå‰é™¤å»æ¨å¥¨ï¼‰" >> copilot_cli_review.md
                  fi
                  
                  if grep -q "try\|catch" "$file"; then
                    echo "- âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å®Ÿè£…æ¸ˆã¿" >> copilot_cli_review.md
                  fi
                  ;;
                html)
                  echo "**ğŸ“„ HTML ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ:**" >> copilot_cli_review.md
                  if grep -q "alt=\|aria-" "$file"; then
                    echo "- âœ… ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£å±æ€§ã‚ã‚Š" >> copilot_cli_review.md
                  else
                    echo "- ğŸ’¡ altå±æ€§ã‚„ARIAå±æ€§ã®è¿½åŠ ã‚’æ¨å¥¨" >> copilot_cli_review.md
                  fi
                  ;;
                css)
                  echo "**ğŸ¨ CSS ãƒ•ã‚¡ã‚¤ãƒ«åˆ†æ:**" >> copilot_cli_review.md
                  echo "- ã‚µã‚¤ã‚º: $(wc -c < "$file") bytes" >> copilot_cli_review.md
                  if grep -q "@media" "$file"; then
                    echo "- âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³å¯¾å¿œ" >> copilot_cli_review.md
                  fi
                  ;;
              esac
              
              echo "" >> copilot_cli_review.md
            fi
          done < <(echo "$CHANGED_FILES")
        else
          echo "### âš ï¸ GitHub Copilot CLI æœªåˆ©ç”¨" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "GitHub Copilot CLI æ‹¡å¼µæ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "**å¯èƒ½ãªç†ç”±:**" >> copilot_cli_review.md
          echo "- GitHub Copilot ãƒ©ã‚¤ã‚»ãƒ³ã‚¹èªè¨¼ãŒå¿…è¦" >> copilot_cli_review.md
          echo "- æ‹¡å¼µæ©Ÿèƒ½ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼" >> copilot_cli_review.md
          echo "- API ãƒ¬ãƒ¼ãƒˆåˆ¶é™" >> copilot_cli_review.md
          echo "" >> copilot_cli_review.md
          echo "**ğŸ’¡ ä»£æ›¿æ‰‹æ®µ:** VS Code ã§ GitHub Copilot ã‚’ç›´æ¥ä½¿ç”¨ã™ã‚‹ã“ã¨ã‚’æ¨å¥¨ã—ã¾ã™ã€‚" >> copilot_cli_review.md
        fi
        
        echo "" >> copilot_cli_review.md
        echo "---" >> copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        echo "ğŸ¤– **GitHub Copilot CLI çµ±åˆåˆ†æå®Œäº†** - $(date '+%Y-%m-%d %H:%M:%S')" >> copilot_cli_review.md
        echo "" >> copilot_cli_review.md
        echo "ğŸ’¡ **ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º**: VS Code ã§ \`gh copilot suggest\` ã¾ãŸã¯ \`gh copilot explain\` ã‚’ä½¿ç”¨ã—ã¦ã€ã‚ˆã‚Šè©³ç´°ãªææ¡ˆã‚’å¾—ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚" >> copilot_cli_review.md
    
    - name: Post Copilot CLI Review to PR
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # PRã«Copilot CLI ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿
        gh pr comment ${{ github.event.pull_request.number }} \
          --body-file copilot_cli_review.md \
          --repo ${{ github.repository }}
        
        echo "âœ… GitHub Copilot CLI ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒPRã«æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ"
    
    - name: Add Copilot-Related Labels
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Copiloté–¢é€£ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ 
        gh pr edit ${{ github.event.pull_request.number }} \
          --add-label "copilot-reviewed" \
          --add-label "ai-assisted" \
          --repo ${{ github.repository }} || echo "ãƒ©ãƒ™ãƒ«è¿½åŠ ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆãƒ©ãƒ™ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ï¼‰"
        
        echo "âœ… Copiloté–¢é€£ãƒ©ãƒ™ãƒ«ã®è¿½åŠ ã‚’è©¦è¡Œã—ã¾ã—ãŸ"
