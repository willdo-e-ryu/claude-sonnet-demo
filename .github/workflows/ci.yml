name: CI - Lint and Build Test

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies (if package.json exists)
      run: |
        if [ -f package.json ]; then
          npm ci
          npm run lint || echo "No lint script found"
        else
          echo "No package.json found, skipping npm steps"
        fi
    
    - name: Advanced JavaScript Analysis
      run: |
        echo "## ğŸ“Š è©³ç´°ã‚³ãƒ¼ãƒ‰åˆ†æçµæœ" > analysis_report.txt
        echo "" >> analysis_report.txt
        
        # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°åˆ†æ
        find public/js -name "*.js" | while read file; do
          echo "### ğŸ” åˆ†æä¸­: $file" >> analysis_report.txt
          
          # æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
          if node -c "$file" 2>/dev/null; then
            echo "âœ… æ§‹æ–‡ãƒã‚§ãƒƒã‚¯: OK" >> analysis_report.txt
          else
            echo "âŒ æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> analysis_report.txt
            node -c "$file" >> analysis_report.txt 2>&1
          fi
          
          # ã‚³ãƒ¼ãƒ‰å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹
          LINES=$(wc -l < "$file")
          FUNCTIONS=$(grep -c "function\|=>\|class " "$file" || echo "0")
          COMMENTS=$(grep -c "//\|/\*\|\*/" "$file" || echo "0")
          
          echo "ğŸ“ˆ ãƒ¡ãƒˆãƒªã‚¯ã‚¹:" >> analysis_report.txt
          echo "  - è¡Œæ•°: $LINES" >> analysis_report.txt
          echo "  - é–¢æ•°æ•°: $FUNCTIONS" >> analysis_report.txt
          echo "  - ã‚³ãƒ¡ãƒ³ãƒˆæ•°: $COMMENTS" >> analysis_report.txt
          
          # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
          if grep -q "innerHTML\|eval\|document.write" "$file"; then
            echo "âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„: æ½œåœ¨çš„ã«å±é™ºãªé–¢æ•°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ" >> analysis_report.txt
          fi
          
          echo "" >> analysis_report.txt
        done
        
        cat analysis_report.txt
    
    - name: Validate HTML and CSS
      run: |
        echo "ğŸ” HTML/CSSæ¤œè¨¼ã‚’å®Ÿè¡Œä¸­..."
        
        # HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæœ¬æ§‹æ–‡ãƒã‚§ãƒƒã‚¯
        find public -name "*.html" -exec echo "Checking {}" \; -exec htmlhint {} \; || true
        
        # CSSãƒ•ã‚¡ã‚¤ãƒ«ã®æ¤œè¨¼
        find public -name "*.css" | while read file; do
          echo "CSSæ¤œè¨¼: $file"
          # åŸºæœ¬çš„ãªCSSæ§‹æ–‡ãƒã‚§ãƒƒã‚¯ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          if ! grep -q "}" "$file"; then
            echo "âš ï¸ CSSæ§‹æ–‡ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™: $file"
          fi
        done
    
    - name: Build Docker image
      run: |
        docker build -t flappy-nginx:test .
    
    - name: Test Docker container
      run: |
        # ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
        docker run -d -p 8080:80 --name flappy-test flappy-nginx:test
        
        # å°‘ã—å¾…ã¤
        sleep 5
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        curl -f http://localhost:8080/health || exit 1
        
        # ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯
        curl -f http://localhost:8080/ | grep -q "Flappy Bird" || exit 1
        
        echo "âœ… All tests passed!"
    
    - name: Cleanup
      if: always()
      run: |
        docker stop flappy-test || true
        docker rm flappy-test || true
        docker rmi flappy-nginx:test || true
