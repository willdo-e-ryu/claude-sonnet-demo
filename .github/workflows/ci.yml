name: CI with GitHub C    - name: Setup GitHub CLI and Copilot
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # GitHub CLI èªè¨¼
        echo "$GH_TOKEN" | gh auth login --with-token
        gh auth status
        
        # Copilot æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
        gh extension install github/gh-copilot || {
          echo "âš ï¸ Copilot extension install failed - checking existing installation"
        }
        
        # Copilot åˆ©ç”¨å¯å¦ç¢ºèª
        if gh extension list 2>/dev/null | grep -q "gh-copilot" && gh copilot --help >/dev/null 2>&1; then
          echo "âœ… GitHub CLI Copilot ready for CI analysis"
        else
          echo "âš ï¸ Copilot CLI unavailable - using enhanced static analysis"
        fi:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

jobs:
  lint-test-copilot:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install GitHub CLI with Copilot
      run: |
        # GitHub CLI ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        type -p curl >/dev/null || (sudo apt update && sudo apt install curl -y)
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
        && sudo chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
        && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
        && sudo apt update \
        && sudo apt install gh -y
        
        # Copilot æ‹¡å¼µã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        gh extension install github/gh-copilot
        echo "âœ… GitHub CLI with Copilot ready"
    
    - name: Authenticate GitHub CLI
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "$GH_TOKEN" | gh auth login --with-token
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Install dependencies and run Copilot pre-analysis
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        npm ci
        
        echo "## ğŸ¤– CI - GitHub Copilot å“è³ªåˆ†æ" > ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        echo "### ğŸ“… åˆ†ææ—¥æ™‚: $(date '+%Y-%m-%d %H:%M:%S')" >> ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        
        # Copilot ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ åˆ†æ
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "### ğŸ” ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹é€ ã® Copilot åˆ†æ" >> ci_copilot_report.md
          echo "" >> ci_copilot_report.md
          
          # package.json ã®ä¾å­˜é–¢ä¿‚ã«ã¤ã„ã¦Copilotåˆ†æ
          if [ -f "package.json" ]; then
            echo "**ğŸ“¦ package.json ä¾å­˜é–¢ä¿‚åˆ†æ:**" >> ci_copilot_report.md
            {
              echo "ä»¥ä¸‹ã®JavaScriptãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜é–¢ä¿‚ã¨package.jsonã®æœ€é©åŒ–ã«ã¤ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„:" | \
              gh copilot suggest 2>/dev/null | head -15
            } >> ci_copilot_report.md 2>/dev/null || {
              echo "- ğŸ’¡ Copilotåˆ†æ: ä¾å­˜é–¢ä¿‚ã®æœ€é©åŒ–ã‚’æ¤œè¨" >> ci_copilot_report.md
            }
          fi
          
          echo "" >> ci_copilot_report.md
        fi
    
    - name: Run JavaScript Lint with Copilot Enhancement
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "### ğŸ”§ Lint & Code Quality Analysis" >> ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        
        # æ¨™æº–ã®Lintå®Ÿè¡Œ
        echo "**ğŸ“‹ ESLint çµæœ:**" >> ci_copilot_report.md
        npm run lint 2>&1 | head -20 >> ci_copilot_report.md || {
          echo "- âš ï¸ Lintå®Ÿè¡Œã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ" >> ci_copilot_report.md
          npm run lint 2>&1 | head -10 >> ci_copilot_report.md
        }
        
        echo "" >> ci_copilot_report.md
        
        # Copilot ã§ã‚³ãƒ¼ãƒ‰å“è³ªææ¡ˆ
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "**ğŸ¤– Copilot ã‚³ãƒ¼ãƒ‰å“è³ªææ¡ˆ:**" >> ci_copilot_report.md
          echo "" >> ci_copilot_report.md
          
          # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã®å“è³ªæ”¹å–„ææ¡ˆ
          {
            echo "JavaScript Canvas ã‚²ãƒ¼ãƒ ã®ã‚³ãƒ¼ãƒ‰å“è³ªã¨Lint ã‚¨ãƒ©ãƒ¼ã®è§£æ±ºæ–¹æ³•ã«ã¤ã„ã¦ææ¡ˆã—ã¦ãã ã•ã„" | \
            gh copilot suggest 2>/dev/null | head -20
          } >> ci_copilot_report.md 2>/dev/null || {
            echo "- ğŸ’« Copilot ææ¡ˆãŒä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“" >> ci_copilot_report.md
          }
        fi
    
    - name: Run Tests with Copilot Analysis
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "" >> ci_copilot_report.md
        echo "### ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ & Copilot åˆ†æ" >> ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        
        # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        echo "**ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ:**" >> ci_copilot_report.md
        npm run test 2>&1 | tail -10 >> ci_copilot_report.md || {
          echo "- â„¹ï¸ ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒæœªè¨­å®šã¾ãŸã¯å®Ÿè¡Œã‚¨ãƒ©ãƒ¼" >> ci_copilot_report.md
        }
        
        echo "" >> ci_copilot_report.md
        
        # Copilot ã§ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ææ¡ˆ
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "**ğŸ¤– Copilot ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ææ¡ˆ:**" >> ci_copilot_report.md
          echo "" >> ci_copilot_report.md
          
          {
            echo "Canvas ãƒ™ãƒ¼ã‚¹ã®JavaScriptã‚²ãƒ¼ãƒ ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã¨ãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã®é¸æŠã«ã¤ã„ã¦ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„" | \
            gh copilot suggest 2>/dev/null | head -15
          } >> ci_copilot_report.md 2>/dev/null || {
            echo "- ğŸ’¡ Jest ã¾ãŸã¯ Vitest ã‚’ä½¿ç”¨ã—ãŸãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ" >> ci_copilot_report.md
            echo "- ğŸ¯ Canvas API ã®ãƒ¢ãƒƒã‚¯åŒ–" >> ci_copilot_report.md
            echo "- ğŸ”„ ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ã®å˜ä½“ãƒ†ã‚¹ãƒˆ" >> ci_copilot_report.md
          }
        fi
        
    - name: Validate HTML/CSS with Copilot Enhancement
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "" >> ci_copilot_report.md
        echo "### ï¿½ HTML/CSS æ¤œè¨¼ & Copilot åˆ†æ" >> ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        
        # HTMLHint ã«ã‚ˆã‚‹æ¤œè¨¼
        echo "**ğŸ” HTMLHint çµæœ:**" >> ci_copilot_report.md
        npx htmlhint public/*.html 2>&1 | head -15 >> ci_copilot_report.md || echo "HTMLHint warnings detected" >> ci_copilot_report.md
        
        echo "" >> ci_copilot_report.md
        
        # CSS ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼
        echo "**ğŸ¨ CSS ãƒ•ã‚¡ã‚¤ãƒ«æ¤œè¨¼:**" >> ci_copilot_report.md
        find public -name "*.css" | while read file; do
          if [ -f "$file" ]; then
            FILE_SIZE=$(wc -c < "$file")
            echo "- âœ… $file (${FILE_SIZE} bytes)" >> ci_copilot_report.md
          fi
        done
        
        echo "" >> ci_copilot_report.md
        
        # Copilot ã§HTML/CSSæœ€é©åŒ–ææ¡ˆ
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "**ğŸ¤– Copilot HTML/CSS æœ€é©åŒ–ææ¡ˆ:**" >> ci_copilot_report.md
          echo "" >> ci_copilot_report.md
          
          {
            echo "HTML5 Canvas ã‚²ãƒ¼ãƒ ã®HTMLæ§‹é€ ã¨CSSã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã®æœ€é©åŒ–ã«ã¤ã„ã¦ææ¡ˆã—ã¦ãã ã•ã„" | \
            gh copilot suggest 2>/dev/null | head -15
          } >> ci_copilot_report.md 2>/dev/null || {
            echo "- ğŸ“± ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³ã®æ”¹å–„" >> ci_copilot_report.md
            echo "- âš¡ CSS ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–" >> ci_copilot_report.md
            echo "- ğŸ¯ ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯HTML ã®ä½¿ç”¨" >> ci_copilot_report.md
          }
        fi
    
    - name: Build and Test Docker with Copilot
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "" >> ci_copilot_report.md
        echo "### ğŸ³ Docker ãƒ“ãƒ«ãƒ‰ & Copilot ã‚¤ãƒ³ãƒ•ãƒ©åˆ†æ" >> ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        
        # Docker ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
        echo "**ğŸ”¨ Docker ãƒ“ãƒ«ãƒ‰çµæœ:**" >> ci_copilot_report.md
        BUILD_START=$(date +%s)
        docker build -t flappy-nginx:test . 2>&1 | tail -5 >> ci_copilot_report.md
        BUILD_END=$(date +%s)
        BUILD_TIME=$((BUILD_END - BUILD_START))
        
        echo "- â±ï¸ ãƒ“ãƒ«ãƒ‰æ™‚é–“: ${BUILD_TIME} ç§’" >> ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        
        # Copilot ã§Dockeræœ€é©åŒ–ææ¡ˆ
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "**ğŸ¤– Copilot Docker æœ€é©åŒ–ææ¡ˆ:**" >> ci_copilot_report.md
          echo "" >> ci_copilot_report.md
          
          {
            echo "nginx Alpine ãƒ™ãƒ¼ã‚¹ã®Dockerfileã¨ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®æœ€é©åŒ–ã«ã¤ã„ã¦ææ¡ˆã—ã¦ãã ã•ã„" | \
            gh copilot suggest 2>/dev/null | head -15
          } >> ci_copilot_report.md 2>/dev/null || {
            echo "- ğŸš€ ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®æ´»ç”¨" >> ci_copilot_report.md
            echo "- ğŸ“¦ ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ã®æœ€é©åŒ–" >> ci_copilot_report.md
            echo "- ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ä½¿ç”¨" >> ci_copilot_report.md
          }
        fi
    
    - name: Test Docker Container
      run: |
        echo "" >> ci_copilot_report.md
        echo "**ğŸ§ª ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆçµæœ:**" >> ci_copilot_report.md
        
        # ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
        docker run -d -p 8080:80 --name flappy-test flappy-nginx:test
        
        # å°‘ã—å¾…ã¤
        sleep 5
        
        # ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
        if curl -f http://localhost:8080/health 2>/dev/null; then
          echo "- âœ… ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: æˆåŠŸ" >> ci_copilot_report.md
        else
          echo "- âš ï¸ ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: ã‚¨ãƒ©ãƒ¼" >> ci_copilot_report.md
        fi
        
        # ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã®ãƒã‚§ãƒƒã‚¯
        if curl -f http://localhost:8080/ 2>/dev/null | grep -q "Flappy Bird"; then
          echo "- âœ… ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸: æ­£å¸¸è¡¨ç¤º" >> ci_copilot_report.md
        else
          echo "- âš ï¸ ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸: è¡¨ç¤ºã‚¨ãƒ©ãƒ¼" >> ci_copilot_report.md
        fi
        
        # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        RESPONSE_TIME=$(curl -o /dev/null -s -w "%{time_total}" http://localhost:8080/ 2>/dev/null || echo "0")
        echo "- â±ï¸ ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“: ${RESPONSE_TIME} ç§’" >> ci_copilot_report.md
        
        echo "âœ… All tests completed!"
    
    - name: Generate CI Quality Report
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "" >> ci_copilot_report.md
        echo "### ğŸ“Š CI å“è³ªã‚¹ã‚³ã‚¢" >> ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        
        # å“è³ªã‚¹ã‚³ã‚¢è¨ˆç®—
        QUALITY_SCORE=85
        
        # Dockerãƒ“ãƒ«ãƒ‰æˆåŠŸãƒã‚§ãƒƒã‚¯
        if docker images | grep -q "flappy-nginx:test"; then
          QUALITY_SCORE=$((QUALITY_SCORE + 5))
          echo "- âœ… Docker ãƒ“ãƒ«ãƒ‰: æˆåŠŸ (+5)" >> ci_copilot_report.md
        fi
        
        # ãƒ†ã‚¹ãƒˆçµæœãƒã‚§ãƒƒã‚¯
        if curl -f http://localhost:8080/ >/dev/null 2>&1; then
          QUALITY_SCORE=$((QUALITY_SCORE + 10))
          echo "- âœ… ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ: æˆåŠŸ (+10)" >> ci_copilot_report.md
        fi
        
        echo "" >> ci_copilot_report.md
        echo "**ğŸ¯ ç·åˆå“è³ªã‚¹ã‚³ã‚¢: $QUALITY_SCORE/100**" >> ci_copilot_report.md
        echo "" >> ci_copilot_report.md
        
        # Copilot ã«ã‚ˆã‚‹ç·åˆæ”¹å–„ææ¡ˆ
        if command -v gh >/dev/null 2>&1 && gh extension list | grep -q "gh-copilot" 2>/dev/null; then
          echo "**ğŸš€ Copilot ã«ã‚ˆã‚‹ CI/CD æ”¹å–„ææ¡ˆ:**" >> ci_copilot_report.md
          echo "" >> ci_copilot_report.md
          
          {
            echo "JavaScript Canvas ã‚²ãƒ¼ãƒ ã®CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨DevOpså®Ÿè·µã®æ”¹å–„ã«ã¤ã„ã¦ææ¡ˆã—ã¦ãã ã•ã„" | \
            gh copilot suggest 2>/dev/null | head -15
          } >> ci_copilot_report.md 2>/dev/null || {
            echo "- ğŸ”„ è‡ªå‹•ãƒ†ã‚¹ãƒˆã®æ‹¡å……" >> ci_copilot_report.md
            echo "- ğŸ“ˆ ã‚³ãƒ¼ãƒ‰ã‚«ãƒãƒ¬ãƒƒã‚¸ã®æ¸¬å®š" >> ci_copilot_report.md
            echo "- ğŸš€ ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæˆ¦ç•¥ã®æ”¹å–„" >> ci_copilot_report.md
          }
        fi
        
        echo "" >> ci_copilot_report.md
        echo "---" >> ci_copilot_report.md
        echo "ğŸ¤– **GitHub Copilot CI åˆ†æå®Œäº†** - $(date '+%Y-%m-%d %H:%M:%S')" >> ci_copilot_report.md
    
    - name: Post CI Report (for PR only)
      if: github.event_name == 'pull_request'
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # PRã®å ´åˆã®ã¿ãƒ¬ãƒãƒ¼ãƒˆã‚’æŠ•ç¨¿
        gh pr comment ${{ github.event.pull_request.number }} \
          --body-file ci_copilot_report.md \
          --repo ${{ github.repository }}
        
        echo "âœ… CI Copilot ãƒ¬ãƒãƒ¼ãƒˆãŒPRã«æŠ•ç¨¿ã•ã‚Œã¾ã—ãŸ"
    
    - name: Cleanup
      if: always()
      run: |
        docker stop flappy-test || true
        docker rm flappy-test || true
        docker rmi flappy-nginx:test || true
